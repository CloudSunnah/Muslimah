<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muslimah - by CLOUD SUNNAH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Konfigurasi Tailwind CSS untuk mengaktifkan mode gelap via class
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        html {
            height: 100%;
            width: 100%;
        }

        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .splash-screen {
            background: linear-gradient(to bottom right, #fbcfe8, #fda4af);
        }

        .main-container {
            transition: background-color 0.5s ease;
        }

        .bottom-nav-button-active {
            transform: translateY(-0.5rem);
        }

        .chat-bubble-user {
            border-bottom-right-radius: 0;
        }

        .chat-bubble-bot {
            border-bottom-left-radius: 0;
        }

        .animate-pulse-dot {
            animation: pulse-dot 1.4s infinite ease-in-out both;
        }

        @keyframes pulse-dot {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1.0);
            }
        }

        .animate-pulse-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .animate-pulse-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
    </style>
</head>

<body class="overflow-hidden">

    <!-- Login Screen -->
    <div id="login-screen"
        class="w-full h-screen flex flex-col justify-center items-center fixed inset-0 z-[101] bg-gradient-to-br from-pink-500 via-rose-400 to-pink-600">
        <div class="w-full max-w-md px-6">
            <!-- Logo/Title -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white tracking-widest mb-2"
                    style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2)">MUSLIMAH</h1>
                <p class="text-white/80 text-lg">by CLOUD SUNNAH</p>
            </div>

            <!-- Login Form -->
            <div id="login-form" class="bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl">
                <h2 class="text-2xl font-bold text-center text-slate-800 mb-6">Masuk ke Akun</h2>

                <div class="space-y-4">
                    <div>
                        <input id="login-email" type="email" placeholder="Email"
                            class="w-full px-4 py-3 bg-slate-100 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400 text-slate-800">
                    </div>
                    <div>
                        <input id="login-password" type="password" placeholder="Password"
                            class="w-full px-4 py-3 bg-slate-100 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400 text-slate-800">
                    </div>
                    <button id="login-btn"
                        class="w-full py-3 bg-pink-500 text-white font-semibold rounded-lg hover:bg-pink-600 transition-colors">
                        Masuk
                    </button>
                </div>

                <div class="text-center mt-4">
                    <p class="text-slate-600">Belum punya akun?
                        <button id="show-register-btn" class="text-pink-500 font-semibold hover:text-pink-600">Daftar di
                            sini</button>
                    </p>
                </div>

                <div id="login-error"
                    class="hidden mt-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-lg text-sm"></div>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl hidden">
                <h2 class="text-2xl font-bold text-center text-slate-800 mb-6">Daftar Akun Baru</h2>

                <div class="space-y-4">
                    <div>
                        <input id="register-name" type="text" placeholder="Nama Lengkap"
                            class="w-full px-4 py-3 bg-slate-100 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400 text-slate-800">
                    </div>
                    <div>
                        <input id="register-email" type="email" placeholder="Email"
                            class="w-full px-4 py-3 bg-slate-100 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400 text-slate-800">
                    </div>
                    <div>
                        <input id="register-password" type="password" placeholder="Password (min. 6 karakter)"
                            class="w-full px-4 py-3 bg-slate-100 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400 text-slate-800">
                    </div>
                    <div>
                        <input id="register-confirm-password" type="password" placeholder="Konfirmasi Password"
                            class="w-full px-4 py-3 bg-slate-100 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400 text-slate-800">
                    </div>
                    <button id="register-btn"
                        class="w-full py-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors">
                        Daftar
                    </button>
                </div>

                <div class="text-center mt-4">
                    <p class="text-slate-600">Sudah punya akun?
                        <button id="show-login-btn" class="text-pink-500 font-semibold hover:text-pink-600">Masuk di
                            sini</button>
                    </p>
                </div>

                <div id="register-error"
                    class="hidden mt-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-lg text-sm"></div>
                <div id="register-success"
                    class="hidden mt-4 p-3 bg-green-100 border border-green-300 text-green-700 rounded-lg text-sm">
                </div>
            </div>

            <!-- Waiting for Approval -->
            <div id="waiting-approval" class="bg-white/95 backdrop-blur-sm rounded-2xl p-6 shadow-2xl hidden">
                <div class="text-center">
                    <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-slate-800 mb-2">Menunggu Persetujuan</h2>
                    <p class="text-slate-600 mb-4">Akun Anda sedang menunggu persetujuan dari admin. Anda akan dapat
                        mengakses aplikasi setelah akun disetujui.</p>
                    <button id="logout-btn"
                        class="px-6 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600 transition-colors">
                        Keluar
                    </button>
                </div>
            </div>

            <!-- Loading -->
            <div id="auth-loading" class="hidden text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
                <p class="mt-2 text-white">Memproses...</p>
            </div>
        </div>
    </div>

    <!-- Splash Screen -->
    <div id="splash-screen"
        class="splash-screen w-full h-screen flex flex-col justify-center items-center fixed inset-0 z-[100] transition-opacity duration-500 hidden">
        <div class="text-center">
            <h1 class="text-5xl font-bold text-white tracking-widest" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2)">
                MUSLIMAH</h1>
            <p class="text-white/80 mt-2 text-lg">by CLOUD SUNNAH</p>
        </div>
        <div class="absolute bottom-10 text-white/70 text-sm">Loading...</div>
    </div>

    <!-- Main App Structure -->
    <div id="app-container"
        class="font-sans antialiased w-full h-screen flex flex-col bg-rose-50 dark:bg-slate-900 main-container hidden">
        <main id="main-content" class="flex-grow overflow-y-auto">
            <!-- Content will be rendered here by JavaScript -->
        </main>
        <nav id="bottom-nav-bar"
            class="shrink-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-lg border-t border-slate-200/80 dark:border-slate-700/80 rounded-t-3xl shadow-[0_-5px_20px_-5px_rgba(0,0,0,0.05)]">
            <!-- Bottom Nav will be rendered here by JavaScript -->
        </nav>
    </div>

    <script>
        // === Firebase Configuration ===
        const firebaseConfig = {
            apiKey: "AIzaSyCyYsy5vPRlC8h6eu-o7J6hnSpFbYg-JnU",
            authDomain: "muslimah-ecc7f.firebaseapp.com",
            projectId: "muslimah-ecc7f",
            storageBucket: "muslimah-ecc7f.firebasestorage.app",
            messagingSenderId: "429716762955",
            appId: "1:429716762955:web:e2cbc6728c4dab2c9a38ce",
            measurementId: "G-WDR3VGJKW0"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // === Authentication Functions ===
        const showElement = (id) => document.getElementById(id).classList.remove('hidden');
        const hideElement = (id) => document.getElementById(id).classList.add('hidden');
        const showError = (elementId, message) => {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        };
        const hideError = (elementId) => {
            document.getElementById(elementId).classList.add('hidden');
        };

        const registerUser = async () => {
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;

            hideError('register-error');
            hideElement('register-success');

            if (!name || !email || !password) {
                showError('register-error', 'Semua field harus diisi.');
                return;
            }

            if (password.length < 6) {
                showError('register-error', 'Password minimal 6 karakter.');
                return;
            }

            if (password !== confirmPassword) {
                showError('register-error', 'Password dan konfirmasi password tidak sama.');
                return;
            }

            showElement('auth-loading');

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Update profile dengan nama
                await user.updateProfile({
                    displayName: name
                });

                // Simpan data user ke Firestore dengan status pending
                await db.collection('users').doc(user.uid).set({
                    name: name,
                    email: email,
                    status: 'pending', // pending, approved, rejected
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    uid: user.uid
                });

                document.getElementById('register-success').innerHTML =
                    'Pendaftaran berhasil! Akun Anda akan disetujui oleh admin terlebih dahulu.';
                showElement('register-success');

                // Clear form
                document.getElementById('register-name').value = '';
                document.getElementById('register-email').value = '';
                document.getElementById('register-password').value = '';
                document.getElementById('register-confirm-password').value = '';

                setTimeout(() => {
                    hideElement('register-form');
                    showElement('waiting-approval');
                }, 2000);

            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = 'Terjadi kesalahan saat mendaftar.';

                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email sudah terdaftar. Silakan gunakan email lain atau login.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Format email tidak valid.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password terlalu lemah.';
                }

                showError('register-error', errorMessage);
            } finally {
                hideElement('auth-loading');
            }
        };

        const loginUser = async () => {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            hideError('login-error');

            if (!email || !password) {
                showError('login-error', 'Email dan password harus diisi.');
                return;
            }

            showElement('auth-loading');

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Check user status di Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();

                if (!userDoc.exists) {
                    // Jika user tidak ada di Firestore, buat data baru dengan status pending
                    await db.collection('users').doc(user.uid).set({
                        name: user.displayName || 'User',
                        email: user.email,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        uid: user.uid
                    });

                    hideElement('login-form');
                    showElement('waiting-approval');
                    return;
                }

                const userData = userDoc.data();

                if (userData.status === 'pending') {
                    hideElement('login-form');
                    showElement('waiting-approval');
                } else if (userData.status === 'approved') {
                    // User disetujui, lanjut ke aplikasi
                    proceedToApp();
                } else if (userData.status === 'rejected') {
                    await auth.signOut();
                    showError('login-error', 'Akun Anda ditolak oleh admin. Silakan hubungi administrator.');
                } else {
                    // Status tidak dikenal, default ke pending
                    hideElement('login-form');
                    showElement('waiting-approval');
                }

            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Terjadi kesalahan saat login.';

                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Email tidak terdaftar. Silakan daftar terlebih dahulu.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Password salah.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Format email tidak valid.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Terlalu banyak percobaan login. Coba lagi nanti.';
                }

                showError('login-error', errorMessage);
            } finally {
                hideElement('auth-loading');
            }
        };

        const logoutUser = async () => {
            try {
                await auth.signOut();
                hideElement('waiting-approval');
                showElement('login-form');

                // Clear forms
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        const proceedToApp = () => {
            hideElement('login-screen');
            showElement('splash-screen');

            // Initialize app
            if (typeof window.initApp === 'function') {
                window.initApp();
            }

            setTimeout(() => {
                const splashScreen = document.getElementById('splash-screen');
                const appContainer = document.getElementById('app-container');

                splashScreen.style.opacity = '0';
                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex');
                setTimeout(() => splashScreen.style.display = 'none', 500);
            }, 1500);
        };

        // === Auth State Listener ===
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User sudah login, cek status di Firestore
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();

                    if (userDoc.exists) {
                        const userData = userDoc.data();

                        if (userData.status === 'approved') {
                            // Jika user sudah disetujui dan sedang di halaman login, langsung masuk
                            if (!document.getElementById('login-screen').classList.contains('hidden')) {
                                proceedToApp();
                            }
                        } else if (userData.status === 'pending') {
                            // Tampilkan halaman waiting
                            hideElement('login-form');
                            hideElement('register-form');
                            showElement('waiting-approval');
                        } else if (userData.status === 'rejected') {
                            // Logout jika ditolak
                            await auth.signOut();
                        }
                    } else {
                        // User tidak ada di Firestore, buat dengan status pending
                        await db.collection('users').doc(user.uid).set({
                            name: user.displayName || 'User',
                            email: user.email,
                            status: 'pending',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            uid: user.uid
                        });

                        hideElement('login-form');
                        hideElement('register-form');
                        showElement('waiting-approval');
                    }
                } catch (error) {
                    console.error('Error checking user status:', error);
                }
            } else {
                // User tidak login, tampilkan form login
                hideElement('splash-screen');
                hideElement('app-container');
                showElement('login-screen');
                showElement('login-form');
                hideElement('register-form');
                hideElement('waiting-approval');
            }
        });

        // === Auth Event Listeners ===
        document.addEventListener('DOMContentLoaded', () => {
            // Login/Register form toggles
            document.getElementById('show-register-btn').addEventListener('click', () => {
                hideElement('login-form');
                showElement('register-form');
                hideError('login-error');
            });

            document.getElementById('show-login-btn').addEventListener('click', () => {
                hideElement('register-form');
                showElement('login-form');
                hideError('register-error');
                hideElement('register-success');
            });

            // Form submissions
            document.getElementById('login-btn').addEventListener('click', loginUser);
            document.getElementById('register-btn').addEventListener('click', registerUser);
            document.getElementById('logout-btn').addEventListener('click', logoutUser);

            // Enter key support
            document.getElementById('login-email').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginUser();
            });
            document.getElementById('login-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginUser();
            });
            document.getElementById('register-confirm-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') registerUser();
            });
        });

        // === App State and Logic ===
        document.addEventListener('DOMContentLoaded', () => {
            const mainContent = document.getElementById('main-content');
            const bottomNavBarContainer = document.getElementById('bottom-nav-bar');
            const splashScreen = document.getElementById('splash-screen');
            const appContainer = document.getElementById('app-container');

            // --- App Constants ---
            const FIDYAH_PER_DAY = 45000;

            // --- App State ---
            let state = {
                theme: 'light',
                activeScreen: 'tap-clipz',
                currentDate: new Date(),
                isModalOpen: false,
                selectedDate: null,
                showChatHistory: false,
                modalType: 'start', // 'start' untuk mulai haid, 'end' untuk selesai haid
                tanyaCloud: {
                    prompt: '',
                    messages: [],
                    isLoading: false,
                    error: null,
                    chatHistory: [],
                },
                tapClipz: {
                    currentVideoIndex: 0,
                    videos: [
                        'https://files.catbox.moe/yn4dut.mp4',
                        'https://files.catbox.moe/qwwqwj.mp4',
                        'https://files.catbox.moe/8tczgh.mp4',
                        'https://files.catbox.moe/tqz3g4.mp4',
                        'https://files.catbox.moe/ahvf6o.mp4'
                    ],
                    isVideoLoading: false
                },
                kuiz: {
                    currentQuestion: null,
                    isLoading: false,
                    error: null,
                    userAnswer: '',
                    showResult: false,
                    score: 0,
                    correctAnswer: '',
                    explanation: '',
                    totalQuestions: 0,
                    correctAnswers: 0,
                    history: []
                },
                userData: {
                    menstruationDates: [],
                    menstruationEndDates: [],
                    fastingDebt: 0,
                    manualFastingDebt: 0, // Hutang puasa yang ditambah manual
                },
                prayerTimes: {
                    data: null,
                    location: '',
                    lastUpdated: null,
                    isLoading: false,
                    error: null,
                    countdown: null,
                    nextPrayer: null
                }
            };

            // === Audio System ===
            let audioContext = null;
            let isPlayingClickSound = false;

            const playClickSound = () => {
                // Prevent multiple simultaneous click sounds
                if (isPlayingClickSound) return;

                try {
                    // Initialize audio context only once
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }

                    // Resume audio context if suspended
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }

                    isPlayingClickSound = true;

                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.1);

                    gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);

                    // Reset flag after sound duration
                    setTimeout(() => {
                        isPlayingClickSound = false;
                    }, 150);
                } catch (e) {
                    // Fallback jika audio context tidak didukung
                    isPlayingClickSound = false;
                    console.log("Audio not supported");
                }
            };

            // === ICONS (as functions returning SVG strings) ===
            const icons = {
                CalendarDays: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></svg>`,
                Cloudy: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z" /><path d="M22 10a3 3 0 0 0-3-3h-2.207a5.502 5.502 0 0 0-10.702.5" /></svg>`,
                Settings: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0 2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></svg>`,
                Moon: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" /></svg>`,
                Sun: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>`,
                Minus: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M5 12h14" /></svg>`,
                Plus: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M5 12h14" /><path d="M12 5v14" /></svg>`,
                ChevronLeft: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="m15 18-6-6 6-6" /></svg>`,
                ChevronRight: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="m9 18 6-6-6-6" /></svg>`,
                SendHorizonal: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>`,
                History: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>`,
                Trash2: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`,
                ArrowLeft: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>`,
                Clock: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>`,
                MapPin: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>`,
                BookOpen: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>`,
                CheckCircle: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22,4 12,14.01 9,11.01"/></svg>`,
                XCircle: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>`,
                RotateCcw: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>`,
                Play: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><polygon points="5,3 19,12 5,21"/></svg>`,
            };

            // === Hijri Date Converter (Algoritma yang Lebih Akurat) ===
            const toHijri = (gregorianDate) => {
                // Algoritma yang lebih akurat (Kuwaiti algorithm)
                const int = (n) => Math.floor(n);
                let d = gregorianDate.getDate();
                let m = gregorianDate.getMonth() + 1;
                let y = gregorianDate.getFullYear();

                // Konversi Gregorian ke Julian Day
                let jd = int((1461 * (y + 4800 + int((m - 14) / 12))) / 4) +
                    int((367 * (m - 2 - 12 * (int((m - 14) / 12)))) / 12) -
                    int((3 * (int((y + 4900 + int((m - 14) / 12)) / 100))) / 4) +
                    d - 32075;

                // Konversi Julian Day ke Hijriah
                let l = jd - 1948440 + 10632;
                let n = int((l - 1) / 10631);
                l = l - 10631 * n + 354;
                let j = (int((10985 - l) / 5316)) * (int((50 * l) / 17719)) +
                    (int(l / 5670)) * (int((43 * l) / 15238));
                l = l - (int((30 - j) / 15)) * (int((17719 * j) / 50)) -
                    (int(j / 16)) * (int((15238 * j) / 43)) + 29;

                let hMonth = int((24 * l) / 709);
                let hDay = l - int((709 * hMonth) / 24);
                let hYear = 30 * n + j - 30;

                const monthNames = ["Muharram", "Safar", "Rabi'ul Awwal", "Rabi'ul Akhir", "Jumadal Ula", "Jumadal Akhirah", "Rajab", "Sha'ban", "Ramadan", "Shawwal", "Dzulqaidah", "Dzulhijjah"];

                return {day: hDay, month: hMonth, monthName: monthNames[hMonth - 1], year: hYear};
            };

            // === Sistem Prediksi Menstruasi ===
            const calculateMenstrualPredictions = (userData) => {
                const predictions = {
                    nextPeriod: null,
                    fertileWindow: null,
                    ovulation: null,
                    currentCycle: null,
                    ishadhahWarning: null
                };

                if (userData.menstruationDates.length === 0) return predictions;

                // Urutkan tanggal menstruasi dengan parsing yang benar
                const sortedDates = userData.menstruationDates.map(dateStr => {
                    const parts = dateStr.split('-');
                    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                }).sort((a, b) => a - b);
                const lastPeriod = sortedDates[sortedDates.length - 1];

                // Hitung rata-rata siklus dari 3 siklus terakhir atau default 28 hari
                let avgCycle = 28;
                if (sortedDates.length >= 2) {
                    const cycles = [];
                    for (let i = 1; i < Math.min(4, sortedDates.length); i++) {
                        const cycle = Math.round((sortedDates[i] - sortedDates[i - 1]) / (1000 * 60 * 60 * 24));
                        if (cycle >= 21 && cycle <= 35) cycles.push(cycle);
                    }
                    if (cycles.length > 0) {
                        avgCycle = Math.round(cycles.reduce((a, b) => a + b, 0) / cycles.length);
                    }
                }

                // Prediksi haid berikutnya
                const nextPeriodDate = new Date(lastPeriod);
                nextPeriodDate.setDate(nextPeriodDate.getDate() + avgCycle);
                predictions.nextPeriod = nextPeriodDate;

                // Prediksi ovulasi (14 hari sebelum haid berikutnya)
                const ovulationDate = new Date(nextPeriodDate);
                ovulationDate.setDate(ovulationDate.getDate() - 14);
                predictions.ovulation = ovulationDate;

                // Masa subur (5 hari sebelum dan 1 hari setelah ovulasi)
                const fertileStart = new Date(ovulationDate);
                fertileStart.setDate(fertileStart.getDate() - 5);
                const fertileEnd = new Date(ovulationDate);
                fertileEnd.setDate(fertileEnd.getDate() + 1);
                predictions.fertileWindow = {start: fertileStart, end: fertileEnd};

                // Periksa ishadhah (haid lebih dari 15 hari berturut-turut)
                const today = new Date();
                const daysSinceLastPeriod = Math.floor((today - lastPeriod) / (1000 * 60 * 60 * 24));
                if (daysSinceLastPeriod <= 15) {
                    // Hitung berapa hari berturut-turut mengalami haid
                    let consecutiveDays = 0;
                    const currentDate = new Date(lastPeriod);
                    while (userData.menstruationDates.includes(currentDate.toISOString().split('T')[0])) {
                        consecutiveDays++;
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    if (consecutiveDays > 15) {
                        predictions.ishadhahWarning = consecutiveDays;
                    }
                }

                return predictions;
            };

            // === Fungsi untuk menghitung hutang puasa otomatis ===
            const calculateAutomaticFastingDebt = (userData) => {
                let ramadanDays = 0;
                userData.menstruationDates.forEach(dateStr => {
                    const date = new Date(dateStr);
                    const hijri = toHijri(date);
                    if (hijri.month === 9) { // Bulan Ramadan
                        ramadanDays++;
                    }
                });
                return ramadanDays;
            };

            // === Sistem Kuiz Islam ===
            const getRandomQuestion = async () => {
                state.kuiz.isLoading = true;
                state.kuiz.error = null;
                state.kuiz.showResult = false;
                render();

                try {
                    // Daftar pertanyaan Islam yang sesuai Al-Quran dan Sunnah
                    const islamicQuestions = [
                        {
                            question: "Berapa jumlah surat dalam Al-Quran?",
                            options: ["112", "113", "114", "115"],
                            correct: 2,
                            explanation: "Al-Quran terdiri dari 114 surat, dimulai dari surat Al-Fatihah hingga An-Nas."
                        },
                        {
                            question: "Apa nama malaikat yang bertugas menyampaikan wahyu?",
                            options: ["Mikail", "Jibril", "Israfil", "Izrail"],
                            correct: 1,
                            explanation: "Malaikat Jibril (Gabriel) adalah malaikat yang bertugas menyampaikan wahyu Allah kepada para nabi."
                        },
                        {
                            question: "Berapa kali sholat fardhu dalam sehari?",
                            options: ["3", "4", "5", "6"],
                            correct: 2,
                            explanation: "Sholat fardhu dilakukan 5 kali sehari: Subuh, Dzuhur, Ashar, Maghrib, dan Isya."
                        },
                        {
                            question: "Apa nama bulan suci umat Islam?",
                            options: ["Muharram", "Rajab", "Ramadan", "Dzulhijjah"],
                            correct: 2,
                            explanation: "Ramadan adalah bulan suci umat Islam dimana diwajibkan puasa dari terbit fajar hingga terbenam matahari."
                        },
                        {
                            question: "Berapa rukun Islam?",
                            options: ["4", "5", "6", "7"],
                            correct: 1,
                            explanation: "Rukun Islam ada 5: Syahadat, Sholat, Zakat, Puasa Ramadan, dan Haji bagi yang mampu."
                        }
                    ];

                    // Pilih pertanyaan random
                    const randomIndex = Math.floor(Math.random() * islamicQuestions.length);
                    const question = islamicQuestions[randomIndex];

                    state.kuiz.currentQuestion = question;
                    state.kuiz.userAnswer = '';

                } catch (error) {
                    console.error('Error getting question:', error);
                    state.kuiz.error = 'Gagal mengambil pertanyaan. Silakan coba lagi.';
                } finally {
                    state.kuiz.isLoading = false;
                    render();
                }
            };

            const submitAnswer = () => {
                if (state.kuiz.userAnswer === '' || !state.kuiz.currentQuestion) return;

                const isCorrect = parseInt(state.kuiz.userAnswer) === state.kuiz.currentQuestion.correct;

                // Hitung skor (1-100)
                state.kuiz.totalQuestions++;
                if (isCorrect) {
                    state.kuiz.correctAnswers++;
                }

                const score = Math.round((state.kuiz.correctAnswers / state.kuiz.totalQuestions) * 100);
                state.kuiz.score = score;
                state.kuiz.correctAnswer = state.kuiz.currentQuestion.options[state.kuiz.currentQuestion.correct];
                state.kuiz.explanation = state.kuiz.currentQuestion.explanation;
                state.kuiz.showResult = true;

                // Simpan ke history
                state.kuiz.history.unshift({
                    question: state.kuiz.currentQuestion.question,
                    userAnswer: state.kuiz.currentQuestion.options[parseInt(state.kuiz.userAnswer)],
                    correctAnswer: state.kuiz.correctAnswer,
                    isCorrect: isCorrect,
                    score: score,
                    timestamp: new Date().toLocaleString('id-ID')
                });

                // Batasi history hanya 20 pertanyaan terakhir
                if (state.kuiz.history.length > 20) {
                    state.kuiz.history = state.kuiz.history.slice(0, 20);
                }

                saveData();
                render();
            };

            const resetQuiz = () => {
                state.kuiz.totalQuestions = 0;
                state.kuiz.correctAnswers = 0;
                state.kuiz.score = 0;
                state.kuiz.history = [];
                state.kuiz.showResult = false;
                state.kuiz.currentQuestion = null;
                saveData();
                render();
            };



            // === Database Kota Indonesia ===
            const INDONESIA_CITIES = [
                // Pulau Jawa
                {name: 'Jakarta', lat: -6.2088, lon: 106.8456, province: 'DKI Jakarta'},
                {name: 'Surabaya', lat: -7.2575, lon: 112.7521, province: 'Jawa Timur'},
                {name: 'Bandung', lat: -6.9175, lon: 107.6191, province: 'Jawa Barat'},
                {name: 'Bekasi', lat: -6.2383, lon: 106.9756, province: 'Jawa Barat'},
                {name: 'Medan', lat: 3.5952, lon: 98.6722, province: 'Sumatera Utara'},
                {name: 'Tangerang', lat: -6.1783, lon: 106.6319, province: 'Banten'},
                {name: 'Depok', lat: -6.4025, lon: 106.7942, province: 'Jawa Barat'},
                {name: 'Semarang', lat: -6.9667, lon: 110.4167, province: 'Jawa Tengah'},
                {name: 'Palembang', lat: -2.9761, lon: 104.7754, province: 'Sumatera Selatan'},
                {name: 'Makassar', lat: -5.1477, lon: 119.4327, province: 'Sulawesi Selatan'},
                {name: 'South Tangerang', lat: -6.2878, lon: 106.7306, province: 'Banten'},
                {name: 'Batam', lat: 1.0456, lon: 104.0305, province: 'Kepulauan Riau'},
                {name: 'Bogor', lat: -6.5950, lon: 106.8167, province: 'Jawa Barat'},
                {name: 'Pekanbaru', lat: 0.5333, lon: 101.4500, province: 'Riau'},
                {name: 'Bandar Lampung', lat: -5.4292, lon: 105.2610, province: 'Lampung'},

                // Sumatera
                {name: 'Padang', lat: -0.9492, lon: 100.3543, province: 'Sumatera Barat'},
                {name: 'Malang', lat: -7.9797, lon: 112.6304, province: 'Jawa Timur'},
                {name: 'Samarinda', lat: -0.5018, lon: 117.1536, province: 'Kalimantan Timur'},
                {name: 'Tasikmalaya', lat: -7.3506, lon: 108.2170, province: 'Jawa Barat'},
                {name: 'Banjarmasin', lat: -3.3194, lon: 114.5901, province: 'Kalimantan Selatan'},
                {name: 'Pontianak', lat: -0.0263, lon: 109.3425, province: 'Kalimantan Barat'},
                {name: 'Cimahi', lat: -6.8722, lon: 107.5423, province: 'Jawa Barat'},
                {name: 'Denpasar', lat: -8.6500, lon: 115.2167, province: 'Bali'},
                {name: 'Balikpapan', lat: -1.2379, lon: 116.8529, province: 'Kalimantan Timur'},
                {name: 'Jambi', lat: -1.6101, lon: 103.6131, province: 'Jambi'},
                {name: 'Surakarta', lat: -7.5667, lon: 110.8333, province: 'Jawa Tengah'},
                {name: 'Yogyakarta', lat: -7.7956, lon: 110.3695, province: 'DI Yogyakarta'},
                {name: 'Kupang', lat: -10.1772, lon: 123.6070, province: 'Nusa Tenggara Timur'},
                {name: 'Cirebon', lat: -6.7063, lon: 108.5570, province: 'Jawa Barat'},
                {name: 'Serang', lat: -6.1169, lon: 106.1539, province: 'Banten'},
                {name: 'Mataram', lat: -8.5833, lon: 116.1167, province: 'Nusa Tenggara Barat'},

                // Kalimantan
                {name: 'Palangka Raya', lat: -2.2136, lon: 113.9230, province: 'Kalimantan Tengah'},
                {name: 'Manado', lat: 1.4748, lon: 124.8421, province: 'Sulawesi Utara'},
                {name: 'Ambon', lat: -3.6954, lon: 128.1814, province: 'Maluku'},
                {name: 'Jayapura', lat: -2.5489, lon: 140.7000, province: 'Papua'},
                {name: 'Kendari', lat: -3.9450, lon: 122.4989, province: 'Sulawesi Tenggara'},
                {name: 'Palu', lat: -0.8917, lon: 119.8707, province: 'Sulawesi Tengah'},
                {name: 'Gorontalo', lat: 0.5435, lon: 123.0682, province: 'Gorontalo'},
                {name: 'Mamuju', lat: -2.6797, lon: 118.8878, province: 'Sulawesi Barat'},
                {name: 'Ternate', lat: 0.7886, lon: 127.3784, province: 'Maluku Utara'},
                {name: 'Bengkulu', lat: -3.8004, lon: 102.2655, province: 'Bengkulu'},
                {name: 'Banda Aceh', lat: 5.5483, lon: 95.3238, province: 'Aceh'},

                // Kota-kota Besar Lainnya
                {name: 'Cilegon', lat: -6.0022, lon: 106.0194, province: 'Banten'},
                {name: 'Sukabumi', lat: -6.9278, lon: 106.9319, province: 'Jawa Barat'},
                {name: 'Cirebon', lat: -6.7325, lon: 108.5570, province: 'Jawa Barat'},
                {name: 'Purwokerto', lat: -7.4217, lon: 109.2339, province: 'Jawa Tengah'},
                {name: 'Magelang', lat: -7.4700, lon: 110.2167, province: 'Jawa Tengah'},
                {name: 'Tegal', lat: -6.8694, lon: 109.1403, province: 'Jawa Tengah'},
                {name: 'Pekalongan', lat: -6.8886, lon: 109.6753, province: 'Jawa Tengah'},
                {name: 'Kediri', lat: -7.8167, lon: 112.0167, province: 'Jawa Timur'},
                {name: 'Blitar', lat: -8.0983, lon: 112.1681, province: 'Jawa Timur'},
                {name: 'Mojokerto', lat: -7.4667, lon: 112.4333, province: 'Jawa Timur'},
                {name: 'Madiun', lat: -7.6297, lon: 111.5239, province: 'Jawa Timur'},
                {name: 'Jember', lat: -8.1667, lon: 113.7000, province: 'Jawa Timur'},
                {name: 'Banyuwangi', lat: -8.2192, lon: 114.3689, province: 'Jawa Timur'},
                {name: 'Probolinggo', lat: -7.7542, lon: 113.2156, province: 'Jawa Timur'},

                // Sumatera Lengkap
                {name: 'Binjai', lat: 3.6000, lon: 98.4833, province: 'Sumatera Utara'},
                {name: 'Pematangsiantar', lat: 2.9667, lon: 99.0667, province: 'Sumatera Utara'},
                {name: 'Tebing Tinggi', lat: 3.3333, lon: 99.1667, province: 'Sumatera Utara'},
                {name: 'Dumai', lat: 1.6667, lon: 101.4500, province: 'Riau'},
                {name: 'Bukittinggi', lat: -0.3000, lon: 100.3700, province: 'Sumatera Barat'},
                {name: 'Solok', lat: -0.7917, lon: 100.6583, province: 'Sumatera Barat'},
                {name: 'Payakumbuh', lat: -0.2167, lon: 100.6333, province: 'Sumatera Barat'},
                {name: 'Lubuklinggau', lat: -3.3000, lon: 102.8667, province: 'Sumatera Selatan'},
                {name: 'Prabumulih', lat: -3.4333, lon: 104.2333, province: 'Sumatera Selatan'},
                {name: 'Metro', lat: -5.1139, lon: 105.3067, province: 'Lampung'},

                // Kalimantan Lengkap
                {name: 'Tarakan', lat: 3.3000, lon: 117.6333, province: 'Kalimantan Utara'},
                {name: 'Bontang', lat: 0.1333, lon: 117.5000, province: 'Kalimantan Timur'},
                {name: 'Singkawang', lat: 0.9000, lon: 108.9833, province: 'Kalimantan Barat'},

                // Sulawesi
                {name: 'Makassar', lat: -5.1477, lon: 119.4327, province: 'Sulawesi Selatan'},
                {name: 'Pare-Pare', lat: -4.0167, lon: 119.6333, province: 'Sulawesi Selatan'},
                {name: 'Palopo', lat: -2.9833, lon: 120.2000, province: 'Sulawesi Selatan'},
                {name: 'Bitung', lat: 1.4500, lon: 125.1833, province: 'Sulawesi Utara'},
                {name: 'Tomohon', lat: 1.3333, lon: 124.8333, province: 'Sulawesi Utara'},
                {name: 'Kotamobagu', lat: 0.7333, lon: 124.3167, province: 'Sulawesi Utara'},
                {name: 'Bau-Bau', lat: -5.4833, lon: 122.6000, province: 'Sulawesi Tenggara'},

                // Nusa Tenggara & Maluku
                {name: 'Singaraja', lat: -8.1167, lon: 115.0833, province: 'Bali'},
                {name: 'Bima', lat: -8.4667, lon: 118.7167, province: 'Nusa Tenggara Barat'},
                {name: 'Ende', lat: -8.8500, lon: 121.6667, province: 'Nusa Tenggara Timur'},
                {name: 'Maumere', lat: -8.6167, lon: 122.2167, province: 'Nusa Tenggara Timur'},
                {name: 'Tual', lat: -5.6333, lon: 132.7500, province: 'Maluku'},
                {name: 'Tidore', lat: 0.6833, lon: 127.4000, province: 'Maluku Utara'},

                // Papua
                {name: 'Sorong', lat: -0.8667, lon: 131.2500, province: 'Papua Barat'},
                {name: 'Merauke', lat: -8.4833, lon: 140.4000, province: 'Papua'},
                {name: 'Nabire', lat: -3.3667, lon: 135.5000, province: 'Papua'},
                {name: 'Timika', lat: -4.5333, lon: 136.8833, province: 'Papua'},
                {name: 'Biak', lat: -1.1833, lon: 136.0833, province: 'Papua'},
                {name: 'Wamena', lat: -4.1000, lon: 138.9500, province: 'Papua'},

                // Kota-kota Tambahan
                {name: 'Indramayu', lat: -6.3264, lon: 108.3200, province: 'Jawa Barat'},
                {name: 'Garut', lat: -7.2125, lon: 107.9000, province: 'Jawa Barat'},
                {name: 'Banjar', lat: -7.3667, lon: 108.5333, province: 'Jawa Barat'},
                {name: 'Subang', lat: -6.5667, lon: 107.7500, province: 'Jawa Barat'},
                {name: 'Purwakarta', lat: -6.5500, lon: 107.4333, province: 'Jawa Barat'},
                {name: 'Karawang', lat: -6.3000, lon: 107.3000, province: 'Jawa Barat'},
                {name: 'Cianjur', lat: -6.8167, lon: 107.1333, province: 'Jawa Barat'},
                {name: 'Kuningan', lat: -6.9833, lon: 108.4833, province: 'Jawa Barat'},
                {name: 'Wonogiri', lat: -7.8167, lon: 110.9167, province: 'Jawa Tengah'},
                {name: 'Klaten', lat: -7.7056, lon: 110.6056, province: 'Jawa Tengah'},
                {name: 'Boyolali', lat: -7.5333, lon: 110.5833, province: 'Jawa Tengah'},
                {name: 'Sukoharjo', lat: -7.6833, lon: 110.8333, province: 'Jawa Tengah'},
                {name: 'Karanganyar', lat: -7.6000, lon: 111.0333, province: 'Jawa Tengah'},
                {name: 'Sragen', lat: -7.4167, lon: 111.0000, province: 'Jawa Tengah'},
                {name: 'Gresik', lat: -7.1556, lon: 112.6536, province: 'Jawa Timur'},
                {name: 'Sidoarjo', lat: -7.4486, lon: 112.7181, province: 'Jawa Timur'},
                {name: 'Pasuruan', lat: -7.6453, lon: 112.9075, province: 'Jawa Timur'},
                {name: 'Lumajang', lat: -8.1333, lon: 113.2167, province: 'Jawa Timur'},
                {name: 'Bondowoso', lat: -7.9167, lon: 113.8167, province: 'Jawa Timur'},
                {name: 'Situbondo', lat: -7.7056, lon: 114.0097, province: 'Jawa Timur'},
                {name: 'Ngawi', lat: -7.4042, lon: 111.4464, province: 'Jawa Timur'},
                {name: 'Magetan', lat: -7.6167, lon: 111.3500, province: 'Jawa Timur'},
                {name: 'Pacitan', lat: -8.2000, lon: 111.0833, province: 'Jawa Timur'},
                {name: 'Ponorogo', lat: -7.8667, lon: 111.4667, province: 'Jawa Timur'},
                {name: 'Trenggalek', lat: -8.0500, lon: 111.7167, province: 'Jawa Timur'},
                {name: 'Tulungagung', lat: -8.0667, lon: 111.9000, province: 'Jawa Timur'}
            ];

            // Fungsi untuk mencari kota
            const searchCity = (query) => {
                if (!query || query.trim().length < 2) return [];

                const searchTerm = query.toLowerCase().trim();
                return INDONESIA_CITIES.filter(city =>
                    city.name.toLowerCase().includes(searchTerm) ||
                    city.province.toLowerCase().includes(searchTerm)
                ).slice(0, 10); // Batasi hasil maksimal 10
            };

            // === Sistem Jadwal Sholat ===
            const getPrayerTimes = async (city = '') => {
                state.prayerTimes.isLoading = true;
                state.prayerTimes.error = null;
                render();

                try {
                    let lat, lon, detectedCity = '', regionName = '';

                    if (city.trim()) {
                        // Cari di database kota lokal terlebih dahulu
                        const cityData = INDONESIA_CITIES.find(c =>
                            c.name.toLowerCase() === city.toLowerCase().trim()
                        );

                        if (cityData) {
                            // Gunakan data dari database lokal
                            lat = cityData.lat;
                            lon = cityData.lon;
                            state.prayerTimes.location = `${cityData.name}, ${cityData.province}`;
                        } else {
                            // Jika tidak ditemukan di database lokal, coba geocoding
                            try {
                                const geocodeUrl = `https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(city + ', Indonesia')}&key=demo&limit=1`;
                                const geocodeResponse = await fetch(geocodeUrl);
                                const geocodeData = await geocodeResponse.json();

                                if (geocodeData.results && geocodeData.results.length > 0) {
                                    const result = geocodeData.results[0];
                                    lat = result.geometry.lat;
                                    lon = result.geometry.lng;
                                    state.prayerTimes.location = `${city} (geocoded)`;
                                } else {
                                    throw new Error('Kota tidak ditemukan');
                                }
                            } catch (geocodeError) {
                                // Fallback ke Jakarta jika tidak ditemukan
                                const jakartaData = INDONESIA_CITIES.find(c => c.name === 'Jakarta');
                                lat = jakartaData.lat;
                                lon = jakartaData.lon;
                                state.prayerTimes.location = `${city}`;
                            }
                        }
                    } else {
                        // Dapatkan lokasi berdasarkan IP dengan fallback
                        try {
                            // Coba API geolocation yang mendukung HTTPS
                            const locationResponse = await fetch('https://ipapi.co/json/');
                            const locationData = await locationResponse.json();

                            if (locationData.latitude && locationData.longitude) {
                                lat = locationData.latitude;
                                lon = locationData.longitude;
                                detectedCity = locationData.city || 'Unknown';
                                regionName = locationData.region || 'Indonesia';
                                state.prayerTimes.location = `${detectedCity}, ${regionName}`;
                            } else {
                                throw new Error('Gagal mendeteksi lokasi');
                            }
                        } catch (ipError) {
                            // Fallback ke Jakarta
                            const jakartaData = INDONESIA_CITIES.find(c => c.name === 'Jakarta');
                            lat = jakartaData.lat;
                            lon = jakartaData.lon;
                            state.prayerTimes.location = 'Jakarta (default)';
                        }
                    }

                    // Gunakan API aladhan dengan HTTPS
                    const prayerUrl = `https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=20`;

                    try {
                        const response = await fetch(prayerUrl);
                        const data = await response.json();

                        if (data.code === 200) {
                            state.prayerTimes.data = data.data;
                            state.prayerTimes.lastUpdated = new Date();
                            calculateNextPrayer();
                            saveData();
                        } else {
                            throw new Error('Gagal mengambil jadwal sholat dari API');
                        }
                    } catch (apiError) {
                        // Fallback ke jadwal sholat default Jakarta
                        console.warn('API tidak tersedia, menggunakan jadwal default Jakarta');
                        state.prayerTimes.data = {
                            timings: {
                                Fajr: "04:30",
                                Dhuhr: "12:00",
                                Asr: "15:15",
                                Maghrib: "18:00",
                                Isha: "19:15"
                            },
                            date: {
                                readable: new Date().toLocaleDateString('id-ID'),
                                hijri: {
                                    date: toHijri(new Date()).day,
                                    month: {en: toHijri(new Date()).monthName},
                                    year: toHijri(new Date()).year
                                }
                            }
                        };
                        state.prayerTimes.location = state.prayerTimes.location || 'Jakarta (default)';
                        state.prayerTimes.lastUpdated = new Date();
                        calculateNextPrayer();
                        saveData();
                    }

                } catch (error) {
                    console.error('Error fetching prayer times:', error);
                    state.prayerTimes.error = 'Gagal memuat jadwal sholat. Silakan coba lagi.';
                } finally {
                    state.prayerTimes.isLoading = false;
                    render();
                }
            };

            const calculateNextPrayer = () => {
                if (!state.prayerTimes.data || !state.prayerTimes.data.timings) return;

                const now = new Date();
                const timings = state.prayerTimes.data.timings;

                // Bersihkan format waktu yang mungkin mengandung timezone
                const cleanTime = (timeStr) => {
                    if (!timeStr) return "00:00";
                    // Ambil hanya bagian HH:MM dari string waktu
                    const match = timeStr.match(/(\d{1,2}):(\d{2})/);
                    return match ? `${match[1].padStart(2, '0')}:${match[2]}` : "00:00";
                };

                const prayers = [
                    {name: 'Subuh', time: cleanTime(timings.Fajr), arabic: ''},
                    {name: 'Dzuhur', time: cleanTime(timings.Dhuhr), arabic: ''},
                    {name: 'Ashar', time: cleanTime(timings.Asr), arabic: ''},
                    {name: 'Maghrib', time: cleanTime(timings.Maghrib), arabic: ''},
                    {name: 'Isya', time: cleanTime(timings.Isha), arabic: ''}
                ];

                for (let prayer of prayers) {
                    const [hours, minutes] = prayer.time.split(':');
                    const prayerTime = new Date();
                    prayerTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

                    if (prayerTime > now) {
                        state.prayerTimes.nextPrayer = prayer;
                        return;
                    }
                }

                // Jika sudah lewat Isya, sholat berikutnya adalah Subuh esok hari
                const [fajrHours, fajrMinutes] = prayers[0].time.split(':');
                state.prayerTimes.nextPrayer = {
                    name: 'Subuh',
                    time: prayers[0].time,
                    arabic: '',
                    isNextDay: true
                };
            };

            const updateCountdown = () => {
                if (!state.prayerTimes.nextPrayer || !state.prayerTimes.nextPrayer.time) return;

                try {
                    const now = new Date();
                    const prayer = state.prayerTimes.nextPrayer;
                    const [hours, minutes] = prayer.time.split(':');

                    if (!hours || !minutes) return;

                    let prayerTime = new Date();
                    prayerTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

                    if (prayer.isNextDay || prayerTime <= now) {
                        prayerTime.setDate(prayerTime.getDate() + 1);
                    }

                    const diff = prayerTime - now;

                    if (diff > 0) {
                        const countdownHours = Math.floor(diff / (1000 * 60 * 60));
                        const countdownMinutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const countdownSeconds = Math.floor((diff % (1000 * 60)) / 1000);

                        state.prayerTimes.countdown = {
                            hours: countdownHours.toString().padStart(2, '0'),
                            minutes: countdownMinutes.toString().padStart(2, '0'),
                            seconds: countdownSeconds.toString().padStart(2, '0'),
                            total: diff
                        };
                    } else {
                        state.prayerTimes.countdown = null;
                        calculateNextPrayer();
                    }
                } catch (error) {
                    console.error('Error updating countdown:', error);
                    state.prayerTimes.countdown = null;
                }
            };

            // === Sistem Tap Clipz ===
            const getRandomVideo = () => {
                playClickSound();
                state.tapClipz.isVideoLoading = true;
                render();

                // Pilih video random
                const randomIndex = Math.floor(Math.random() * state.tapClipz.videos.length);
                state.tapClipz.currentVideoIndex = randomIndex;

                // Simulasi loading untuk user experience yang lebih baik
                setTimeout(() => {
                    state.tapClipz.isVideoLoading = false;
                    render();
                }, 500);
            };

            // === Fungsi untuk City Search Dropdown ===
            const showCityDropdown = (cities) => {
                const dropdown = document.getElementById('city-search-dropdown');
                if (!dropdown) return;

                if (cities.length === 0) {
                    dropdown.innerHTML = '<div class="p-3 text-center text-slate-500 dark:text-slate-400 text-sm">Kota tidak ditemukan</div>';
                } else {
                    dropdown.innerHTML = cities.map(city => `
                        <div class="city-option p-3 hover:bg-slate-100 dark:hover:bg-slate-600 cursor-pointer border-b border-slate-100 dark:border-slate-600 last:border-b-0" data-city-name="${city.name}">
                            <div class="font-medium text-slate-800 dark:text-white">${city.name}</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400">${city.province}</div>
                        </div>
                    `).join('');
                }

                dropdown.classList.remove('hidden');
            };

            const hideCityDropdown = () => {
                const dropdown = document.getElementById('city-search-dropdown');
                if (dropdown) {
                    dropdown.classList.add('hidden');
                }
            };

            // Update countdown setiap detik
            setInterval(() => {
                if (state.prayerTimes.nextPrayer && state.activeScreen === 'settings') {
                    updateCountdown();
                    const countdownElement = document.getElementById('prayer-countdown');
                    if (countdownElement && state.prayerTimes.countdown) {
                        countdownElement.innerHTML = `
                            <div class="text-2xl font-bold text-green-600 dark:text-green-400">
                                ${state.prayerTimes.countdown.hours}:${state.prayerTimes.countdown.minutes}:${state.prayerTimes.countdown.seconds}
                            </div>
                            <div class="text-sm text-slate-500 dark:text-slate-400">
                                menuju ${state.prayerTimes.nextPrayer.name} ${state.prayerTimes.nextPrayer.arabic}
                            </div>
                        `;
                    }
                }
            }, 1000);

            // --- Data Persistence ---
            const saveData = () => {
                try {
                    localStorage.setItem('muslimahAppData', JSON.stringify(state.userData));
                    localStorage.setItem('muslimahAppTheme', state.theme);
                    localStorage.setItem('muslimahChatHistory', JSON.stringify(state.tanyaCloud.chatHistory));
                    localStorage.setItem('muslimahKuizData', JSON.stringify({
                        totalQuestions: state.kuiz.totalQuestions,
                        correctAnswers: state.kuiz.correctAnswers,
                        score: state.kuiz.score,
                        history: state.kuiz.history
                    }));
                    localStorage.setItem('muslimahPrayerTimes', JSON.stringify({
                        data: state.prayerTimes.data,
                        location: state.prayerTimes.location,
                        lastUpdated: state.prayerTimes.lastUpdated
                    }));
                } catch (e) {console.error("Failed to save data:", e);}
            };

            const loadData = () => {
                try {
                    const savedData = localStorage.getItem('muslimahAppData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        state.userData = {
                            menstruationDates: data.menstruationDates || [],
                            menstruationEndDates: data.menstruationEndDates || [],
                            fastingDebt: data.fastingDebt || 0,
                            manualFastingDebt: data.manualFastingDebt || data.fastingDebt || 0
                        };

                        // Recalculate total debt
                        const automaticDebt = calculateAutomaticFastingDebt(state.userData);
                        state.userData.fastingDebt = automaticDebt + state.userData.manualFastingDebt;
                    }
                    const savedTheme = localStorage.getItem('muslimahAppTheme');
                    if (savedTheme) state.theme = savedTheme;
                    const savedChatHistory = localStorage.getItem('muslimahChatHistory');
                    if (savedChatHistory) state.tanyaCloud.chatHistory = JSON.parse(savedChatHistory);

                    const savedKuizData = localStorage.getItem('muslimahKuizData');
                    if (savedKuizData) {
                        const kuizData = JSON.parse(savedKuizData);
                        state.kuiz.totalQuestions = kuizData.totalQuestions || 0;
                        state.kuiz.correctAnswers = kuizData.correctAnswers || 0;
                        state.kuiz.score = kuizData.score || 0;
                        state.kuiz.history = kuizData.history || [];
                    }

                    const savedPrayerTimes = localStorage.getItem('muslimahPrayerTimes');
                    if (savedPrayerTimes) {
                        const prayerData = JSON.parse(savedPrayerTimes);
                        const lastUpdated = new Date(prayerData.lastUpdated);
                        const now = new Date();

                        // Update jadwal sholat jika data lebih dari 24 jam
                        if ((now - lastUpdated) < 24 * 60 * 60 * 1000) {
                            state.prayerTimes.data = prayerData.data;
                            state.prayerTimes.location = prayerData.location;
                            state.prayerTimes.lastUpdated = lastUpdated;
                            calculateNextPrayer();
                        }
                    }
                } catch (e) {console.error("Failed to load data:", e);}
            };

            // === Chat History Management ===
            const saveChatToHistory = (messages) => {
                if (messages.length === 0) return;

                const chatSession = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    messages: [...messages],
                    title: messages[0]?.text?.substring(0, 50) + (messages[0]?.text?.length > 50 ? '...' : '') || 'Chat Baru'
                };

                state.tanyaCloud.chatHistory.unshift(chatSession);

                // Batasi riwayat hanya 50 chat terakhir
                if (state.tanyaCloud.chatHistory.length > 50) {
                    state.tanyaCloud.chatHistory = state.tanyaCloud.chatHistory.slice(0, 50);
                }

                saveData();
            };

            const loadChatFromHistory = (chatId) => {
                const chat = state.tanyaCloud.chatHistory.find(c => c.id === chatId);
                if (chat) {
                    state.tanyaCloud.messages = [...chat.messages];
                    state.showChatHistory = false;
                    render();
                }
            };

            const deleteChatFromHistory = (chatId) => {
                state.tanyaCloud.chatHistory = state.tanyaCloud.chatHistory.filter(c => c.id !== chatId);
                saveData();
                render();
            };

            const clearAllChatHistory = () => {
                state.tanyaCloud.chatHistory = [];
                saveData();
                render();
            };

            const applyTheme = () => {
                if (state.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            };

            // --- UI Rendering Functions ---
            const renderHeader = () => `
                <header class="mb-6 flex justify-between items-center p-4 sm:p-6">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800 dark:text-white">Muslimah</h1>
                        <p class="text-slate-500 dark:text-slate-400">Your Daily Companion</p>
                    </div>
                </header>`;

            const renderCalendarScreen = () => {
                const {currentDate, userData} = state;
                const today = new Date();
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // Hitung prediksi menstruasi
                const predictions = calculateMenstrualPredictions(userData);

                // Hitung total hutang puasa (otomatis + manual)
                const automaticDebt = calculateAutomaticFastingDebt(userData);
                const totalDebt = automaticDebt + userData.manualFastingDebt;

                let calendarCells = '';
                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarCells += `<div class="bg-transparent"></div>`;
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateObj = new Date(year, month, day);
                    const dateString = dateObj.toISOString().split('T')[0];
                    const hijri = toHijri(dateObj);
                    const isToday = dateObj.toDateString() === today.toDateString();
                    const isMenstruation = userData.menstruationDates.includes(dateString);
                    const isMenstruationEnd = userData.menstruationEndDates.includes(dateString);

                    // Periksa apakah tanggal ini adalah prediksi haid berikutnya
                    const isNextPeriodPrediction = predictions.nextPeriod &&
                        dateObj.getFullYear() === predictions.nextPeriod.getFullYear() &&
                        dateObj.getMonth() === predictions.nextPeriod.getMonth() &&
                        dateObj.getDate() === predictions.nextPeriod.getDate();

                    // Periksa apakah tanggal ini dalam masa subur
                    const isFertileWindow = predictions.fertileWindow &&
                        dateObj.getTime() >= predictions.fertileWindow.start.getTime() &&
                        dateObj.getTime() <= predictions.fertileWindow.end.getTime();

                    // Periksa apakah tanggal ini adalah ovulasi
                    const isOvulation = predictions.ovulation &&
                        dateObj.getFullYear() === predictions.ovulation.getFullYear() &&
                        dateObj.getMonth() === predictions.ovulation.getMonth() &&
                        dateObj.getDate() === predictions.ovulation.getDate();

                    let bgClass = '';
                    let indicators = '';

                    if (isToday) {
                        bgClass = 'bg-pink-500 text-white';
                    } else if (isMenstruation) {
                        bgClass = 'bg-red-200 dark:bg-red-800/50';
                        indicators += '<div class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full pointer-events-none"></div>';
                    } else if (isMenstruationEnd) {
                        bgClass = 'bg-pink-200 dark:bg-pink-800/50';
                        indicators += '<div class="absolute top-1 right-1 w-2 h-2 bg-pink-500 rounded-full pointer-events-none"></div>';
                    } else if (isNextPeriodPrediction) {
                        bgClass = 'bg-red-100 dark:bg-red-900/30 border-2 border-red-400';
                        indicators += '<div class="absolute top-1 left-1 w-2 h-2 bg-red-400 rounded-full pointer-events-none"></div>';
                    } else if (isOvulation) {
                        bgClass = 'bg-blue-200 dark:bg-blue-800/50';
                        indicators += '<div class="absolute top-1 right-1 w-2 h-2 bg-blue-500 rounded-full pointer-events-none"></div>';
                    } else if (isFertileWindow) {
                        bgClass = 'bg-green-100 dark:bg-green-800/30';
                        indicators += '<div class="absolute top-1 right-1 w-1.5 h-1.5 bg-green-500 rounded-full pointer-events-none"></div>';
                    } else {
                        bgClass = 'text-slate-700 dark:text-slate-200';
                    }

                    calendarCells += `
                        <div data-date="${dateString}" class="calendar-day relative h-14 flex flex-col justify-center items-center rounded-lg cursor-pointer transition-all duration-200 hover:bg-rose-100 dark:hover:bg-slate-700 ${bgClass}">
                            <span class="text-sm pointer-events-none">${day}</span>
                            <span class="text-xs pointer-events-none ${isToday ? 'text-white/70' : 'text-slate-400'}">${hijri.day}</span>
                            ${indicators}
                        </div>`;
                }

                // Render prediksi dan keterangan
                let predictionsHtml = '';
                if (predictions.nextPeriod) {
                    predictionsHtml = `
                        <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-rose-100/50 dark:shadow-slate-950/50">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-3">Prediksi Siklus Menstruasi</h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-600 dark:text-slate-400">Haid Berikutnya:</span>
                                    <span class="font-semibold text-red-600 dark:text-red-400">${predictions.nextPeriod.toLocaleDateString('id-ID')}</span>
                                </div>
                                ${predictions.ovulation ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-600 dark:text-slate-400">Ovulasi:</span>
                                        <span class="font-semibold text-blue-600 dark:text-blue-400">${predictions.ovulation.toLocaleDateString('id-ID')}</span>
                                    </div>
                                ` : ''}
                                ${predictions.fertileWindow ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-600 dark:text-slate-400">Masa Subur:</span>
                                        <span class="font-semibold text-green-600 dark:text-green-400">
                                            ${predictions.fertileWindow.start.toLocaleDateString('id-ID')} - 
                                            ${predictions.fertileWindow.end.toLocaleDateString('id-ID')}
                                        </span>
                                    </div>
                                ` : ''}
                                ${predictions.ishadhahWarning ? `
                                    <div class="p-3 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg">
                                        <span class="text-yellow-800 dark:text-yellow-200 font-medium"> Perhatian: Haid sudah ${predictions.ishadhahWarning} hari. Jika lebih dari 15 hari, konsultasikan dengan dokter.</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Keterangan Warna -->
                        <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-rose-100/50 dark:shadow-slate-950/50">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-3">Keterangan</h3>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-red-200 dark:bg-red-800/50 rounded"></div>
                                    <span class="text-slate-600 dark:text-slate-400">Haid</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-pink-200 dark:bg-pink-800/50 rounded"></div>
                                    <span class="text-slate-600 dark:text-slate-400">Akhir Haid</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-red-100 dark:bg-red-900/30 border border-red-400 rounded"></div>
                                    <span class="text-slate-600 dark:text-slate-400">Prediksi Haid</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-blue-200 dark:bg-blue-800/50 rounded"></div>
                                    <span class="text-slate-600 dark:text-slate-400">Ovulasi</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-green-100 dark:bg-green-800/30 rounded"></div>
                                    <span class="text-slate-600 dark:text-slate-400">Masa Subur</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-pink-500 rounded"></div>
                                    <span class="text-slate-600 dark:text-slate-400">Hari Ini</span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="p-4 sm:p-6 space-y-6">
                        <!-- Quick Stats -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-rose-100/50 dark:shadow-slate-950/50">
                                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Hutang Puasa</h3>
                                <p class="text-3xl font-bold text-pink-500 dark:text-pink-400">${totalDebt} <span class="text-lg">hari</span></p>
                                <p class="text-xs text-slate-400 dark:text-slate-500">Otomatis: ${automaticDebt} | Manual: ${userData.manualFastingDebt}</p>
                            </div>
                            <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-rose-100/50 dark:shadow-slate-950/50">
                                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Total Fidyah</h3>
                                <p class="text-3xl font-bold text-pink-500 dark:text-pink-400">Rp ${(totalDebt * FIDYAH_PER_DAY).toLocaleString('id-ID')}</p>
                                <p class="text-xs text-slate-400 dark:text-slate-500">Asumsi Rp ${FIDYAH_PER_DAY.toLocaleString('id-ID')}/hari</p>
                            </div>
                        </div>

                        <!-- Calendar -->
                        <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-rose-100/50 dark:shadow-slate-950/50">
                            <div class="flex justify-between items-center mb-4">
                                <button id="prev-month-btn" class="p-2 rounded-full hover:bg-rose-100 dark:hover:bg-slate-700" title="Bulan Sebelumnya">${icons.ChevronLeft("text-slate-600 dark:text-slate-300")}</button>
                                <div>
                                    <p class="font-bold text-lg text-slate-800 dark:text-white text-center">${currentDate.toLocaleString('id-ID', {month: 'long', year: 'numeric'})}</p>
                                    <p class="text-sm text-slate-500 dark:text-slate-400 text-center">${toHijri(currentDate).monthName} ${toHijri(currentDate).year} H</p>
                                </div>
                                <button id="next-month-btn" class="p-2 rounded-full hover:bg-rose-100 dark:hover:bg-slate-700" title="Bulan Berikutnya">${icons.ChevronRight("text-slate-600 dark:text-slate-300")}</button>
                            </div>
                            <div class="grid grid-cols-7 gap-1 text-center text-xs font-semibold text-slate-500 dark:text-slate-400 mb-2">
                                ${['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'].map(day => `<div>${day}</div>`).join('')}
                            </div>
                            <div id="calendar-grid" class="grid grid-cols-7 gap-1">${calendarCells}</div>
                        </div>

                        ${predictionsHtml}

                        <!-- Fasting Manager -->
                        <div class="space-y-4">
                            <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-rose-100/50 dark:shadow-slate-950/50">
                                <h2 class="text-lg font-bold text-slate-800 dark:text-white mb-2">Manajemen Hutang Puasa Manual</h2>
                                <div class="flex items-center justify-center gap-4 my-4">
                                    <button id="decrease-debt-btn" class="p-3 bg-rose-100 dark:bg-slate-700 text-pink-600 dark:text-pink-400 rounded-full transition-transform active:scale-90" title="Kurangi Hutang">${icons.Minus("w-6 h-6")}</button>
                                    <span class="text-5xl font-bold w-24 text-center text-slate-800 dark:text-white">${userData.manualFastingDebt}</span>
                                    <button id="increase-debt-btn" class="p-3 bg-rose-100 dark:bg-slate-700 text-pink-600 dark:text-pink-400 rounded-full transition-transform active:scale-90" title="Tambah Hutang">${icons.Plus("w-6 h-6")}</button>
                                </div>
                                <p class="text-center text-sm text-slate-500 dark:text-slate-400">Ubah jumlah hari hutang puasa manual. Hutang dari Ramadan akan ditambahkan otomatis.</p>
                            </div>
                        </div>
                    </div>
                `;
            };



            const renderTapClipzScreen = () => {
                const {tapClipz} = state;
                const currentVideo = tapClipz.videos[tapClipz.currentVideoIndex];

                if (tapClipz.isVideoLoading) {
                    return `
                        <div class="h-full flex flex-col justify-center items-center">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500"></div>
                            <p class="mt-4 text-slate-500 dark:text-slate-400">Memuat video...</p>
                        </div>
                    `;
                }

                return `
                    <div class="h-full">
                        <!-- Video Player Full Screen -->
                        <div class="h-full bg-black">
                            <video 
                                id="tap-clipz-video"
                                class="w-full h-full object-contain"
                                controls
                                autoplay
                                preload="metadata"
                                poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 225'%3E%3Crect width='400' height='225' fill='%23000000'/%3E%3Ctext x='200' y='112' text-anchor='middle' fill='%23ffffff' font-family='Arial' font-size='16'%3EMemuat Video...%3C/text%3E%3C/svg%3E"
                            >
                                <source src="${currentVideo}" type="video/mp4">
                                Browser Anda tidak mendukung pemutar video.
                            </video>
                        </div>
                    </div>
                `;
            };

            const renderKuizScreen = () => {
                const {kuiz} = state;

                if (kuiz.isLoading) {
                    return `
                        <div class="p-4 sm:p-6 h-full flex flex-col justify-center items-center">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500"></div>
                            <p class="mt-4 text-slate-500 dark:text-slate-400">Mengambil pertanyaan...</p>
                        </div>
                    `;
                }

                if (kuiz.error) {
                    return `
                        <div class="p-4 sm:p-6 h-full flex flex-col justify-center items-center">
                            <div class="text-red-500 text-center mb-6">
                                ${icons.XCircle("mx-auto h-12 w-12 mb-4")}
                                <p class="text-lg font-semibold">Terjadi Kesalahan</p>
                                <p class="text-sm">${kuiz.error}</p>
                            </div>
                            <button id="retry-question-btn" class="px-6 py-3 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors">
                                Coba Lagi
                            </button>
                        </div>
                    `;
                }

                if (kuiz.showResult && kuiz.currentQuestion) {
                    const isCorrect = kuiz.userAnswer !== '' && parseInt(kuiz.userAnswer) === kuiz.currentQuestion.correct;
                    return `
                        <div class="p-4 sm:p-6 space-y-6">
                            <!-- Hasil Jawaban -->
                            <div class="p-6 bg-white dark:bg-slate-800 rounded-2xl shadow-lg">
                                <div class="text-center mb-6">
                                    ${isCorrect ?
                            `${icons.CheckCircle("mx-auto h-16 w-16 text-green-500 mb-4")}
                                         <h2 class="text-2xl font-bold text-green-600 dark:text-green-400">Jawaban Benar!</h2>` :
                            `${icons.XCircle("mx-auto h-16 w-16 text-red-500 mb-4")}
                                         <h2 class="text-2xl font-bold text-red-600 dark:text-red-400">Jawaban Salah</h2>`
                        }
                                </div>

                                <!-- Pertanyaan -->
                                <div class="mb-4">
                                    <h3 class="font-semibold text-slate-800 dark:text-white mb-2">Pertanyaan:</h3>
                                    <p class="text-slate-600 dark:text-slate-300">${kuiz.currentQuestion.question}</p>
                                </div>

                                <!-- Jawaban User -->
                                ${kuiz.userAnswer !== '' ? `
                                    <div class="mb-4">
                                        <h3 class="font-semibold text-slate-800 dark:text-white mb-2">Jawaban Anda:</h3>
                                        <p class="text-slate-600 dark:text-slate-300 ${isCorrect ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">${kuiz.currentQuestion.options[parseInt(kuiz.userAnswer)]}</p>
                                    </div>
                                ` : ''}

                                <!-- Jawaban Benar -->
                                <div class="mb-4">
                                    <h3 class="font-semibold text-slate-800 dark:text-white mb-2">Jawaban Benar:</h3>
                                    <p class="text-green-600 dark:text-green-400 font-medium">${kuiz.correctAnswer}</p>
                                </div>

                                <!-- Penjelasan -->
                                <div class="mb-6">
                                    <h3 class="font-semibold text-slate-800 dark:text-white mb-2">Penjelasan:</h3>
                                    <p class="text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-700 p-3 rounded-lg">${kuiz.explanation}</p>
                                </div>

                                <!-- Skor -->
                                <div class="text-center p-4 bg-pink-50 dark:bg-pink-900/20 rounded-lg mb-6">
                                    <h3 class="font-semibold text-slate-800 dark:text-white mb-2">Skor Anda</h3>
                                    <p class="text-4xl font-bold text-pink-600 dark:text-pink-400">${kuiz.score}/100</p>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">${kuiz.correctAnswers}/${kuiz.totalQuestions} pertanyaan benar</p>
                                </div>

                                <!-- Tombol Aksi -->
                                <div class="flex gap-3">
                                    <button id="next-question-btn" class="flex-1 px-4 py-3 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors">
                                        Pertanyaan Berikutnya
                                    </button>
                                    <button id="reset-quiz-btn" class="px-4 py-3 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                                        ${icons.RotateCcw("w-5 h-5")}
                                    </button>
                                </div>
                            </div>

                            <!-- History Singkat -->
                            ${kuiz.history.length > 0 ? `
                                <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg">
                                    <h3 class="font-semibold text-slate-800 dark:text-white mb-3">Riwayat Terakhir</h3>
                                    <div class="space-y-2 max-h-40 overflow-y-auto">
                                        ${kuiz.history.slice(0, 3).map(item => `
                                            <div class="flex items-center gap-3 p-2 bg-slate-50 dark:bg-slate-700 rounded-lg">
                                                ${item.isCorrect ?
                                icons.CheckCircle("w-5 h-5 text-green-500") :
                                icons.XCircle("w-5 h-5 text-red-500")
                            }
                                                <div class="flex-1">
                                                    <p class="text-sm text-slate-600 dark:text-slate-300 truncate">${item.question}</p>
                                                    <p class="text-xs text-slate-400">${item.timestamp}</p>
                                                </div>
                                                <span class="text-sm font-medium ${item.isCorrect ? 'text-green-600' : 'text-red-600'}">${item.score}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                if (kuiz.currentQuestion) {
                    return `
                        <div class="p-4 sm:p-6 space-y-6">
                            <!-- Statistik -->
                            <div class="grid grid-cols-3 gap-4">
                                <div class="p-3 bg-white dark:bg-slate-800 rounded-xl text-center">
                                    <p class="text-sm text-slate-500 dark:text-slate-400">Pertanyaan</p>
                                    <p class="text-xl font-bold text-pink-500">${kuiz.totalQuestions + 1}</p>
                                </div>
                                <div class="p-3 bg-white dark:bg-slate-800 rounded-xl text-center">
                                    <p class="text-sm text-slate-500 dark:text-slate-400">Benar</p>
                                    <p class="text-xl font-bold text-green-500">${kuiz.correctAnswers}</p>
                                </div>
                                <div class="p-3 bg-white dark:bg-slate-800 rounded-xl text-center">
                                    <p class="text-sm text-slate-500 dark:text-slate-400">Skor</p>
                                    <p class="text-xl font-bold text-blue-500">${kuiz.totalQuestions > 0 ? Math.round((kuiz.correctAnswers / kuiz.totalQuestions) * 100) : 0}</p>
                                </div>
                            </div>

                            <!-- Pertanyaan -->
                            <div class="p-6 bg-white dark:bg-slate-800 rounded-2xl shadow-lg">
                                <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-6">${kuiz.currentQuestion.question}</h2>

                                <div class="space-y-3">
                                    ${kuiz.currentQuestion.options.map((option, index) => `
                                        <label class="flex items-center p-4 bg-slate-50 dark:bg-slate-700 rounded-lg cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors">
                                            <input type="radio" name="answer" value="${index}" class="mr-3 text-pink-500" ${kuiz.userAnswer == index ? 'checked' : ''}>
                                            <span class="text-slate-700 dark:text-slate-200">${option}</span>
                                        </label>
                                    `).join('')}
                                </div>

                                <button id="submit-answer-btn" 
                                        class="w-full mt-6 px-6 py-3 bg-pink-500 text-white font-semibold rounded-lg hover:bg-pink-600 transition-colors disabled:bg-pink-300 dark:disabled:bg-slate-600 disabled:cursor-not-allowed"
                                        ${kuiz.userAnswer === '' ? 'disabled' : ''}>
                                    Submit Jawaban
                                </button>
                            </div>
                        </div>
                    `;
                }

                // Tampilan awal - belum ada pertanyaan
                return `
                    <div class="p-4 sm:p-6 h-full flex flex-col justify-center items-center">
                        <div class="text-center mb-8">
                            ${icons.BookOpen("mx-auto h-20 w-20 text-pink-500 mb-6")}
                            <h1 class="text-3xl font-bold text-slate-800 dark:text-white mb-4">Kuiz Islam</h1>
                            <p class="text-slate-600 dark:text-slate-300 mb-2">Uji pengetahuan Anda tentang Islam</p>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Berdasarkan Al-Quran dan Sunnah</p>
                        </div>

                        ${kuiz.totalQuestions > 0 ? `
                            <div class="w-full max-w-md p-6 bg-white dark:bg-slate-800 rounded-2xl shadow-lg mb-6">
                                <h3 class="font-semibold text-slate-800 dark:text-white text-center mb-4">Statistik Anda</h3>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div>
                                        <p class="text-2xl font-bold text-pink-500">${kuiz.totalQuestions}</p>
                                        <p class="text-sm text-slate-500 dark:text-slate-400">Pertanyaan</p>
                                    </div>
                                    <div>
                                        <p class="text-2xl font-bold text-green-500">${kuiz.score}</p>
                                        <p class="text-sm text-slate-500 dark:text-slate-400">Skor Terakhir</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <button id="start-quiz-btn" class="px-8 py-4 bg-pink-500 text-white font-semibold rounded-lg hover:bg-pink-600 transition-colors text-lg">
                            ${kuiz.totalQuestions > 0 ? 'Lanjutkan Kuiz' : 'Mulai Kuiz'}
                        </button>

                        ${kuiz.totalQuestions > 0 ? `
                            <button id="reset-quiz-btn" class="mt-4 px-6 py-2 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors">
                                Reset Statistik
                            </button>
                        ` : ''}
                    </div>
                `;
            };

            const renderTanyaCloudScreen = () => {
                if (state.showChatHistory) {
                    return renderChatHistoryScreen();
                }

                const {messages, isLoading} = state.tanyaCloud;
                let messagesHtml = messages.map(msg => `
                    <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xs md:max-w-md lg:max-w-lg px-4 py-3 shadow-md ${msg.role === 'user' ? 'bg-emerald-100 dark:bg-emerald-800 text-slate-800 dark:text-slate-100 rounded-t-2xl rounded-bl-2xl' : 'bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 rounded-t-2xl rounded-br-2xl'}">
                            <p class="whitespace-pre-wrap">${msg.text}</p>
                        </div>
                    </div>
                `).join('');

                if (isLoading) {
                    messagesHtml += `
                        <div class="flex justify-start">
                            <div class="px-4 py-3 rounded-2xl bg-white dark:bg-slate-700 chat-bubble-bot shadow-md">
                                <div class="flex items-center gap-2">
                                    <div class="w-2 h-2 bg-slate-400 rounded-full animate-pulse-dot"></div>
                                    <div class="w-2 h-2 bg-slate-400 rounded-full animate-pulse-dot"></div>
                                    <div class="w-2 h-2 bg-slate-400 rounded-full animate-pulse-dot"></div>
                                </div>
                            </div>
                        </div>`;
                }

                const initialMessage = messages.length === 0 && !isLoading ? `
                    <div class="w-fit mx-auto bg-sky-100 dark:bg-sky-900/50 text-sky-700 dark:text-sky-300 text-sm px-4 py-2 rounded-full shadow">
                        Mulai percakapan dengan Tanya Cloud
                    </div>` : '';

                return `
                    <div class="absolute inset-0 flex flex-col bg-rose-50 dark:bg-slate-900">
                        <!-- Header bergaya WhatsApp -->
                        <header class="flex items-center justify-between p-3 bg-white/80 dark:bg-slate-800/80 backdrop-blur-lg border-b border-slate-200/80 dark:border-slate-700/80 shrink-0 shadow-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 flex items-center justify-center bg-pink-500 rounded-full text-white">
                                    ${icons.Cloudy("w-6 h-6")}
                                </div>
                                <div>
                                    <h1 class="text-lg font-bold text-slate-800 dark:text-white">Tanya Cloud</h1>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">Online</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="new-chat-btn" class="p-2 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition-all active:scale-90" title="Chat Baru">
                                    ${icons.Plus("w-5 h-5")}
                                </button>
                                <button id="chat-history-btn" class="p-2 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition-all active:scale-90" title="Riwayat Chat">
                                    ${icons.History("w-5 h-5")}
                                </button>
                            </div>
                        </header>

                        <!-- Kontainer Chat dengan Latar Belakang -->
                        <div 
                            id="chat-container" 
                            class="flex-grow p-4 overflow-y-auto space-y-4"
                            style="background-image: linear-gradient(rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.8)), url('https://www.transparenttextures.com/patterns/az-subtle.png');"
                        >
                            ${initialMessage}
                            ${messagesHtml}
                        </div>

                        <!-- Area Input Teks di Bawah -->
                        <div class="p-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur-lg border-t border-slate-200/80 dark:border-slate-700/80 shrink-0">
                            <div class="flex items-center gap-2">
                                <input
                                    id="chat-input"
                                    type="text"
                                    value="${state.tanyaCloud.prompt}"
                                    placeholder="Ketik pesan..."
                                    class="flex-grow w-full px-4 py-2 bg-slate-100 dark:bg-slate-700 border-transparent rounded-full focus:outline-none focus:ring-2 focus:ring-pink-400 text-slate-800 dark:text-white"
                                    ${isLoading ? 'disabled' : ''}
                                />
                                <button 
                                    id="send-button"
                                    ${isLoading || !state.tanyaCloud.prompt.trim() ? 'disabled' : ''}
                                    class="w-10 h-10 flex items-center justify-center bg-pink-500 text-white rounded-full disabled:bg-pink-300 dark:disabled:bg-slate-600 disabled:cursor-not-allowed transition-all hover:bg-pink-600 active:scale-90 shrink-0"
                                >
                                    ${icons.SendHorizonal("w-5 h-5")}
                                </button>
                            </div>
                        </div>
                    </div>`;
            };

            const renderChatHistoryScreen = () => {
                const {chatHistory} = state.tanyaCloud;

                let historyHtml = '';
                if (chatHistory.length === 0) {
                    historyHtml = `
                        <div class="text-center text-slate-500 dark:text-slate-400 p-8">
                            ${icons.History("mx-auto h-12 w-12 mb-4")}
                            <p>Belum ada riwayat chat</p>
                            <p class="text-sm mt-2">Mulai chat baru untuk melihat riwayat di sini</p>
                        </div>`;
                } else {
                    historyHtml = chatHistory.map(chat => `
                        <div class="p-4 bg-white dark:bg-slate-700 rounded-xl border border-slate-200 dark:border-slate-600 hover:shadow-md transition-all cursor-pointer chat-history-item" data-chat-id="${chat.id}">
                            <div class="flex justify-between items-start pointer-events-none">
                                <div class="flex-grow">
                                    <h3 class="font-semibold text-slate-800 dark:text-white text-sm">${chat.title}</h3>
                                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">${new Date(chat.timestamp).toLocaleDateString('id-ID', {
                        weekday: 'short',
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}</p>
                                    <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">${chat.messages.length} pesan</p>
                                </div>
                                <button class="p-1 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/30 rounded transition-all pointer-events-auto delete-chat-btn" data-chat-id="${chat.id}" title="Hapus Chat">
                                    ${icons.Trash2("w-4 h-4 pointer-events-none")}
                                </button>
                            </div>
                        </div>
                    `).join('');
                }

                return `
                    <div class="px-4 sm:px-6 pb-4 flex-grow flex flex-col overflow-hidden">
                        <!-- Header riwayat -->
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-3">
                                <button id="back-from-history-btn" class="p-2 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition-all" title="Kembali ke Chat">
                                    ${icons.ArrowLeft("w-5 h-5")}
                                </button>
                                <div>
                                    <h1 class="text-2xl font-bold text-slate-800 dark:text-white">Riwayat Chat</h1>
                                    <p class="text-slate-500 dark:text-slate-400">${chatHistory.length} percakapan tersimpan</p>
                                </div>
                            </div>
                            ${chatHistory.length > 0 ? `
                                <button id="clear-history-btn" class="px-3 py-2 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-all text-sm font-medium">
                                    Hapus Semua
                                </button>
                            ` : ''}
                        </div>

                        <div id="chat-history-list" class="flex-grow bg-white dark:bg-slate-800 rounded-2xl p-4 overflow-y-auto space-y-3">
                            ${historyHtml}
                        </div>
                    </div>`;
            };

            const renderSettingsScreen = () => {
                const {prayerTimes} = state;

                let prayerTimesContent = '';

                if (prayerTimes.isLoading) {
                    prayerTimesContent = `
                        <div class="text-center py-8">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500"></div>
                            <p class="mt-2 text-slate-500 dark:text-slate-400">Mengambil jadwal sholat...</p>
                        </div>
                    `;
                } else if (prayerTimes.error) {
                    prayerTimesContent = `
                        <div class="text-center py-6">
                            <p class="text-red-500 mb-4">${prayerTimes.error}</p>
                            <button id="retry-prayer-times-btn" class="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors">
                                Coba Lagi
                            </button>
                        </div>
                    `;
                } else if (prayerTimes.data && prayerTimes.data.timings) {
                    const timings = prayerTimes.data.timings;

                    // Bersihkan format waktu
                    const cleanTime = (timeStr) => {
                        if (!timeStr) return "00:00";
                        const match = timeStr.match(/(\d{1,2}):(\d{2})/);
                        return match ? `${match[1].padStart(2, '0')}:${match[2]}` : "00:00";
                    };

                    const prayers = [
                        {name: 'Subuh', time: cleanTime(timings.Fajr), arabic: ''},
                        {name: 'Dzuhur', time: cleanTime(timings.Dhuhr), arabic: ''},
                        {name: 'Ashar', time: cleanTime(timings.Asr), arabic: ''},
                        {name: 'Maghrib', time: cleanTime(timings.Maghrib), arabic: ''},
                        {name: 'Isya', time: cleanTime(timings.Isha), arabic: ''}
                    ];

                    updateCountdown();

                    prayerTimesContent = `
                        <div class="space-y-4">
                            <!-- Next Prayer Countdown -->
                            ${prayerTimes.nextPrayer ? `
                                <div class="text-center p-4 bg-gradient-to-r from-green-100 to-blue-100 dark:from-green-900/30 dark:to-blue-900/30 rounded-xl">
                                    <h4 class="text-sm font-semibold text-slate-600 dark:text-slate-300 mb-2">Sholat Berikutnya</h4>
                                    <div id="prayer-countdown">
                                        ${prayerTimes.countdown ? `
                                            <div class="text-2xl font-bold text-green-600 dark:text-green-400">
                                                ${prayerTimes.countdown.hours}:${prayerTimes.countdown.minutes}:${prayerTimes.countdown.seconds}
                                            </div>
                                            <div class="text-sm text-slate-500 dark:text-slate-400">
                                                menuju ${prayerTimes.nextPrayer.name} ${prayerTimes.nextPrayer.arabic}
                                            </div>
                                        ` : `
                                            <div class="text-lg font-semibold text-green-600 dark:text-green-400">
                                                ${prayerTimes.nextPrayer.name} ${prayerTimes.nextPrayer.arabic}
                                            </div>
                                            <div class="text-sm text-slate-500 dark:text-slate-400">
                                                ${prayerTimes.nextPrayer.time}
                                            </div>
                                        `}
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Location Info -->
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2">
                                    ${icons.MapPin("text-slate-500 w-4 h-4")}
                                    <span class="text-slate-600 dark:text-slate-400">${prayerTimes.location}</span>
                                </div>
                                <button id="refresh-prayer-times-btn" class="text-pink-500 hover:text-pink-600 transition-colors">
                                    Perbarui
                                </button>
                            </div>

                            <!-- Prayer Times List -->
                            <div class="grid grid-cols-1 gap-2">
                                ${prayers.map(prayer => `
                                    <div class="flex justify-between items-center py-2 px-3 rounded-lg ${prayerTimes.nextPrayer && prayerTimes.nextPrayer.name === prayer.name ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800' : 'bg-slate-50 dark:bg-slate-700/50'}">
                                        <div class="flex items-center gap-3">
                                            <span class="text-sm font-medium text-slate-700 dark:text-slate-200">${prayer.name}</span>
                                            <span class="text-xs text-slate-500 dark:text-slate-400">${prayer.arabic}</span>
                                        </div>
                                        <span class="font-semibold ${prayerTimes.nextPrayer && prayerTimes.nextPrayer.name === prayer.name ? 'text-green-600 dark:text-green-400' : 'text-slate-600 dark:text-slate-300'}">${prayer.time}</span>
                                    </div>
                                `).join('')}
                            </div>

                            <!-- Date Info -->
                            <div class="text-center text-xs text-slate-400 dark:text-slate-500 pt-2">
                                ${prayerTimes.data.date ?
                            `${prayerTimes.data.date.readable || new Date().toLocaleDateString('id-ID')} | ${prayerTimes.data.date.hijri ? `${prayerTimes.data.date.hijri.date} ${prayerTimes.data.date.hijri.month.en} ${prayerTimes.data.date.hijri.year}` : `${toHijri(new Date()).day} ${toHijri(new Date()).monthName} ${toHijri(new Date()).year} H`}` :
                            `${new Date().toLocaleDateString('id-ID')} | ${toHijri(new Date()).day} ${toHijri(new Date()).monthName} ${toHijri(new Date()).year} H`
                        }
                            </div>
                        </div>
                    `;
                } else {
                    prayerTimesContent = `
                        <div class="text-center py-6">
                            <p class="text-slate-500 dark:text-slate-400 mb-4">Jadwal sholat belum dimuat</p>
                            <button id="load-prayer-times-btn" class="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors">
                                Muat Jadwal Sholat
                            </button>
                        </div>
                    `;
                }

                return `
                    <div class="p-4 sm:p-6 space-y-6">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">Pengaturan</h2>

                        <!-- Prayer Times -->
                        <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-rose-100/50 dark:shadow-slate-950/50">
                            <div class="flex items-center gap-3 mb-4">
                                ${icons.Clock("text-pink-500")}
                                <h3 class="font-semibold text-slate-700 dark:text-slate-200">Jadwal Sholat</h3>
                            </div>

                            <!-- City Search -->
                            <div class="mb-4">
                                <div class="relative">
                                    <div class="flex gap-2">
                                        <div class="flex-grow relative">
                                            <input 
                                                id="city-search-input" 
                                                type="text" 
                                                placeholder="Ketik nama kota di Indonesia..." 
                                                class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400 text-slate-800 dark:text-white text-sm"
                                                autocomplete="off"
                                            />
                                            <!-- Dropdown hasil pencarian -->
                                            <div id="city-search-dropdown" class="absolute top-full left-0 right-0 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto hidden">
                                                <!-- Hasil pencarian akan muncul di sini -->
                                            </div>
                                        </div>
                                        <button id="search-city-btn" class="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors text-sm">
                                            Cari
                                        </button>
                                        <button id="clear-city-btn" class="px-3 py-2 bg-slate-300 dark:bg-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-400 dark:hover:bg-slate-500 transition-colors text-sm" title="Reset ke lokasi otomatis">
                                            Reset
                                        </button>
                                    </div>
                                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                        Database lengkap 98 kota di Indonesia. Kosongkan untuk deteksi lokasi otomatis.
                                    </p>
                                </div>
                            </div>

                            ${prayerTimesContent}
                        </div>

                        <!-- Theme Toggle -->
                        <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-rose-100/50 dark:shadow-slate-950/50 flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                ${state.theme === 'light' ? icons.Sun("text-pink-500") : icons.Moon("text-pink-400")}
                                <span class="font-semibold text-slate-700 dark:text-slate-200">Mode Tampilan</span>
                            </div>
                            <button id="theme-toggle-btn" class="relative inline-flex items-center h-8 w-14 rounded-full transition-colors ${state.theme === 'light' ? 'bg-pink-500' : 'bg-slate-600'}">
                                <span class="inline-block w-6 h-6 transform bg-white rounded-full transition-transform ${state.theme === 'light' ? 'translate-x-1' : 'translate-x-7'}"></span>
                            </button>
                        </div>

                        <!-- Account Info -->
                        <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-rose-100/50 dark:shadow-slate-950/50">
                            <h3 class="font-semibold text-slate-700 dark:text-slate-200 mb-2">Informasi Akun</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400">
                                Data Anda disimpan secara lokal di perangkat ini. Menghapus data aplikasi akan menghilangkan semua catatan Anda. Anda juga dapat menghubungi kami di WA:0856-4854-5159 atau email ke cloudsunnah.massage@gmail.com
                            </p>
                        </div>

                        <!-- About -->
                        <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-rose-100/50 dark:shadow-slate-950/50 text-center">
                            <h3 class="font-semibold text-slate-700 dark:text-slate-200">Muslimah App v1.0</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Dibuat dengan  oleh <strong>CLOUD SUNNAH</strong></p>
                        </div>
                    </div>`;
            };

            const renderBottomNav = () => {
                const navItems = [
                    {id: 'tap-clipz', label: 'Tap Clipz', icon: icons.Play},
                    {id: 'kuiz', label: 'Kuiz', icon: icons.BookOpen},
                    {id: 'calendar', label: 'Kalender', icon: icons.CalendarDays},
                    {id: 'tanya-cloud', label: 'Tanya Cloud', icon: icons.Cloudy},
                    {id: 'settings', label: 'Pengaturan', icon: icons.Settings},
                ];

                bottomNavBarContainer.innerHTML = `
                    <div class="flex justify-around items-center max-w-md mx-auto h-20">
                        ${navItems.map(item => `
                            <button
                                data-screen="${item.id}"
                                class="nav-button flex flex-col items-center justify-center w-20 h-20 transition-all duration-300 transform ${state.activeScreen === item.id ? 'bottom-nav-button-active' : ''}"
                            >
                                <div class="p-3 rounded-full transition-all duration-300 pointer-events-none ${state.activeScreen === item.id ? 'bg-pink-500 shadow-lg shadow-pink-300/50 dark:shadow-pink-800/50' : ''}">
                                    ${item.icon(`transition-colors duration-300 pointer-events-none ${state.activeScreen === item.id ? 'text-white' : 'text-slate-500 dark:text-slate-400'}`)}
                                </div>
                                <span class="text-xs mt-1 font-bold transition-colors duration-300 pointer-events-none ${state.activeScreen === item.id ? 'text-pink-600 dark:text-pink-400' : 'text-slate-500 dark:text-slate-400'}">
                                    ${item.label}
                                </span>
                            </button>
                        `).join('')}
                    </div>
                `;
            };

            const renderModal = () => {
                if (state.isModalOpen && state.selectedDate) {
                    // Parsing tanggal yang benar tanpa timezone offset
                    const dateParts = state.selectedDate.split('-');
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed in JavaScript
                    const day = parseInt(dateParts[2]);

                    const localDate = new Date(year, month, day);

                    const isMarkedStart = state.userData.menstruationDates.includes(state.selectedDate);
                    const isMarkedEnd = state.userData.menstruationEndDates.includes(state.selectedDate);

                    const modalHtml = `
                    <div id="menstruation-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex justify-center items-center z-50 p-4">
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-full max-w-sm text-center shadow-2xl">
                            <p class="text-slate-500 dark:text-slate-400 mb-6">Pilih jenis penanda:</p>
                            <div class="flex flex-col gap-3">
                                <button id="mark-start-period-btn" class="w-full ${isMarkedStart ? 'bg-red-500' : 'bg-red-400'} text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition-colors">
                                    ${isMarkedStart ? 'Hapus Tanda Mulai Haid' : 'Tandai Mulai Haid'}
                                </button>
                                <button id="mark-end-period-btn" class="w-full ${isMarkedEnd ? 'bg-pink-500' : 'bg-pink-400'} text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-600 transition-colors">
                                    ${isMarkedEnd ? 'Hapus Tanda Selesai Haid' : 'Tandai Selesai Haid'}
                                </button>
                                <button id="cancel-modal-btn" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-bold py-3 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                                    Batal
                                </button>
                            </div>
                        </div>
                    </div>`;
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                } else {
                    const modal = document.getElementById('menstruation-modal');
                    if (modal) modal.remove();
                }
            }

            // --- Event Handlers ---
            const setActiveScreen = (screen) => {
                playClickSound();
                state.activeScreen = screen;
                state.showChatHistory = false;

                // Auto-play video acak saat klik menu Tap Clipz
                if (screen === 'tap-clipz') {
                    getRandomVideo();
                } else {
                    render();
                }
            };
            const changeMonth = (offset) => {
                playClickSound();
                state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() + offset, 1);
                render();
            };
            const handleDayClick = (dateString) => {
                playClickSound();
                state.selectedDate = dateString;
                state.isModalOpen = true;
                render();
            };
            const closeModal = () => {
                playClickSound();
                state.isModalOpen = false;
                state.selectedDate = null;
                render();
            };
            const handleMarkStartPeriod = () => {
                playClickSound();
                if (!state.selectedDate) return;

                const isAlreadyMarked = state.userData.menstruationDates.includes(state.selectedDate);

                if (isAlreadyMarked) {
                    // Hapus tanda
                    state.userData.menstruationDates = state.userData.menstruationDates.filter(d => d !== state.selectedDate);
                } else {
                    // Tambah tanda
                    state.userData.menstruationDates = [...state.userData.menstruationDates, state.selectedDate].sort();

                    // Periksa apakah tanggal ini di bulan Ramadan untuk menambah hutang puasa otomatis
                    const date = new Date(state.selectedDate);
                    const hijri = toHijri(date);
                    if (hijri.month === 9) { // Bulan Ramadan
                        // Tidak perlu menambah manual karena sudah dihitung otomatis
                    }
                }

                // Update state userData dengan total debt yang benar
                state.userData.fastingDebt = calculateAutomaticFastingDebt(state.userData) + state.userData.manualFastingDebt;
                saveData();

                // Auto close modal setelah aksi berhasil
                setTimeout(() => {
                    closeModal();
                }, 100);
            };

            const handleMarkEndPeriod = () => {
                playClickSound();
                if (!state.selectedDate) return;

                const isAlreadyMarked = state.userData.menstruationEndDates.includes(state.selectedDate);

                if (isAlreadyMarked) {
                    // Hapus tanda
                    state.userData.menstruationEndDates = state.userData.menstruationEndDates.filter(d => d !== state.selectedDate);
                } else {
                    // Tambah tanda
                    state.userData.menstruationEndDates = [...state.userData.menstruationEndDates, state.selectedDate].sort();
                }

                saveData();

                // Auto close modal setelah aksi berhasil
                setTimeout(() => {
                    closeModal();
                }, 100);
            };

            const handleDebtChange = (amount) => {
                playClickSound();
                state.userData.manualFastingDebt = Math.max(0, state.userData.manualFastingDebt + amount);
                state.userData.fastingDebt = calculateAutomaticFastingDebt(state.userData) + state.userData.manualFastingDebt;
                saveData();
                render();
            };
            const toggleTheme = () => {
                playClickSound();
                state.theme = state.theme === 'light' ? 'dark' : 'light';
                applyTheme();
                saveData();
                render();
            };
            const toggleChatHistory = () => {
                playClickSound();
                state.showChatHistory = !state.showChatHistory;
                render();
            };
            const handleNewChat = () => {
                playClickSound();
                if (state.tanyaCloud.messages.length > 0) {
                    saveChatToHistory(state.tanyaCloud.messages);
                }
                state.tanyaCloud.messages = [];
                state.tanyaCloud.prompt = '';
                state.tanyaCloud.isLoading = false;
                state.tanyaCloud.error = null;
                render();
            };
            const handleSendMessage = async () => {
                const prompt = state.tanyaCloud.prompt.trim();
                if (!prompt || state.tanyaCloud.isLoading) return;

                playClickSound();

                state.tanyaCloud.messages.push({role: 'user', text: prompt});
                state.tanyaCloud.prompt = '';
                state.tanyaCloud.isLoading = true;
                state.tanyaCloud.error = null;
                render();

                if (!navigator.onLine) {
                    state.tanyaCloud.messages.push({
                        role: 'bot',
                        text: 'Maaf, tidak ada koneksi internet. Silakan periksa koneksi Anda dan coba lagi.'
                    });
                    state.tanyaCloud.isLoading = false;
                    render();
                    return;
                }

                // URL API proxy
                const apiUrl = `https://muslimah-zeta.vercel.app/api/proxy`;

                const systemPrompt = "Anda adalah 'Cloud Sunnah', asisten AI Islami yang ramah, bijak, dan berpengetahuan luas. Jawablah semua pertanyaan dari sudut pandang ajaran Islam berdasarkan Al-Qur'an dan Sunnah. Selalu berikan jawaban yang menenangkan, informatif, dan mudah dipahami oleh audiens Muslimah di Indonesia. Gunakan bahasa Indonesia yang baik dan santun.";

                // Map the entire conversation history to the format required by the Gemini API.
                const contentsForAPI = state.tanyaCloud.messages.map(msg => ({
                    role: msg.role === 'bot' ? 'model' : 'user',
                    parts: [{text: msg.text}]
                }));

                const payload = {
                    contents: contentsForAPI,
                    systemInstruction: {parts: [{text: systemPrompt}]},
                };

                try {
                    // Kirim request ke proxy kita
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    const botMessage = candidate?.content?.parts?.[0]?.text || "Maaf, terjadi sedikit kendala. Coba beberapa saat lagi ya.";

                    state.tanyaCloud.messages.push({role: 'bot', text: botMessage});

                } catch (err) {
                    console.error("Proxy or API Error:", err);
                    state.tanyaCloud.messages.push({role: 'bot', text: generateLocalResponse(prompt)});
                } finally {
                    state.tanyaCloud.isLoading = false;
                    render();
                }
            };
            const generateLocalResponse = (prompt) => {
                const lowerPrompt = prompt.toLowerCase();
                if (lowerPrompt.includes('assalamualaikum') || lowerPrompt.includes('salam')) {
                    return 'Waalaikumsalam warahmatullahi wabarakatuh. Ada yang bisa saya bantu?';
                }
                if (lowerPrompt.includes('haid') || lowerPrompt.includes('menstruasi')) {
                    return 'Haid adalah siklus alami bagi wanita. Selama masa ini, ada beberapa ibadah yang tidak dilakukan seperti sholat dan puasa, namun bisa digantikan dengan dzikir atau mendengarkan kajian. Setelah suci, jangan lupa untuk mengqada puasa yang tertinggal ya.';
                }
                return `Mohon maaf, sepertinya terjadi sedikit gangguan saat terhubung dengan server AI kami. \n\nSebagai AI sederhana, saya menyarankan untuk berkonsultasi dengan ustadz atau ulama terpercaya untuk mendapatkan jawaban yang lebih komprehensif. Sementara itu, selalu ingat untuk senantiasa bertakwa kepada Allah SWT dan mengikuti sunnah Rasulullah SAW. \n\nSilakan coba lagi beberapa saat. Barakallahu fiik! `;
            };

            // --- Attaching Event Listeners ---
            const addGlobalEventListeners = () => {
                // Event delegation for clicks within the main app container
                appContainer.addEventListener('click', (e) => {
                    const target = e.target;

                    // Bottom Nav
                    const navButton = target.closest('.nav-button');
                    if (navButton?.dataset.screen) return setActiveScreen(navButton.dataset.screen);

                    // Calendar Screen
                    if (target.closest('#prev-month-btn')) return changeMonth(-1);
                    if (target.closest('#next-month-btn')) return changeMonth(1);
                    if (target.closest('#decrease-debt-btn')) return handleDebtChange(-1);
                    if (target.closest('#increase-debt-btn')) return handleDebtChange(1);
                    const dayElement = target.closest('.calendar-day');
                    if (dayElement?.dataset.date) return handleDayClick(dayElement.dataset.date);



                    // Tap Clipz Screen events (none needed as auto-play is handled in setActiveScreen)

                    // Kuiz Screen
                    if (target.closest('#start-quiz-btn')) return getRandomQuestion();
                    if (target.closest('#submit-answer-btn')) return submitAnswer();
                    if (target.closest('#next-question-btn')) return getRandomQuestion();
                    if (target.closest('#retry-question-btn')) return getRandomQuestion();
                    if (target.closest('#reset-quiz-btn')) return resetQuiz();

                    // Settings Screen
                    if (target.closest('#theme-toggle-btn')) return toggleTheme();
                    if (target.closest('#load-prayer-times-btn')) return getPrayerTimes();
                    if (target.closest('#retry-prayer-times-btn')) return getPrayerTimes();
                    if (target.closest('#refresh-prayer-times-btn')) return getPrayerTimes(state.prayerTimes.location);
                    if (target.closest('#search-city-btn')) {
                        const cityInput = document.getElementById('city-search-input');
                        if (cityInput) return getPrayerTimes(cityInput.value);
                    }
                    if (target.closest('#clear-city-btn')) {
                        const cityInput = document.getElementById('city-search-input');
                        if (cityInput) {
                            cityInput.value = '';
                            hideCityDropdown();
                        }
                        return getPrayerTimes(''); // Reset ke deteksi otomatis
                    }

                    // City dropdown selection
                    const cityOption = target.closest('.city-option');
                    if (cityOption) {
                        const cityName = cityOption.dataset.cityName;
                        const cityInput = document.getElementById('city-search-input');
                        if (cityInput && cityName) {
                            cityInput.value = cityName;
                            hideCityDropdown();
                            return getPrayerTimes(cityName);
                        }
                    }

                    // Tanya Cloud
                    if (target.closest('#new-chat-btn')) return handleNewChat();
                    if (target.closest('#chat-history-btn')) return toggleChatHistory();
                    if (target.closest('#send-button')) return handleSendMessage();

                    // Chat History
                    if (target.closest('#back-from-history-btn')) return toggleChatHistory();
                    if (target.closest('#clear-history-btn')) return clearAllChatHistory();
                    const deleteBtn = target.closest('.delete-chat-btn');
                    if (deleteBtn) return deleteChatFromHistory(Number(deleteBtn.dataset.chatId));
                    const historyItem = target.closest('.chat-history-item');
                    if (historyItem) return loadChatFromHistory(Number(historyItem.dataset.chatId));
                });

                // Listeners for modals which are appended directly to the body
                document.body.addEventListener('click', e => {
                    // Modal actions
                    if (e.target.closest('#mark-start-period-btn') || e.target.id === 'mark-start-period-btn') return handleMarkStartPeriod();
                    if (e.target.closest('#mark-end-period-btn') || e.target.id === 'mark-end-period-btn') return handleMarkEndPeriod();
                    if (e.target.closest('#cancel-modal-btn') || e.target.id === 'cancel-modal-btn') return closeModal();

                    // Close modal when clicking on modal background
                    if (e.target.id === 'menstruation-modal') return closeModal();
                });

                // Listeners for non-click events that don't bubble well for delegation
                appContainer.addEventListener('input', e => {
                    if (e.target.id === 'chat-input') {
                        state.tanyaCloud.prompt = e.target.value;
                        const sendButton = document.getElementById('send-button');
                        if (sendButton) sendButton.disabled = state.tanyaCloud.isLoading || !state.tanyaCloud.prompt.trim();
                    }

                    // City search autocomplete
                    if (e.target.id === 'city-search-input') {
                        const query = e.target.value;
                        if (query.length >= 2) {
                            const results = searchCity(query);
                            showCityDropdown(results);
                        } else {
                            hideCityDropdown();
                        }
                    }
                });

                // Hide dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    const searchInput = document.getElementById('city-search-input');
                    const dropdown = document.getElementById('city-search-dropdown');

                    if (searchInput && dropdown &&
                        !searchInput.contains(e.target) &&
                        !dropdown.contains(e.target)) {
                        hideCityDropdown();
                    }
                });



                // Event listener untuk radio button kuiz
                appContainer.addEventListener('change', e => {
                    if (e.target.name === 'answer') {
                        state.kuiz.userAnswer = e.target.value;
                        const submitButton = document.getElementById('submit-answer-btn');
                        if (submitButton) submitButton.disabled = false;
                    }
                });

                appContainer.addEventListener('keypress', e => {
                    if (e.target.id === 'chat-input' && e.key === 'Enter') {
                        e.preventDefault();
                        handleSendMessage();
                    }
                    if (e.target.id === 'city-search-input' && e.key === 'Enter') {
                        e.preventDefault();
                        getPrayerTimes(e.target.value);
                    }
                });
            };

            // --- Main Render Function ---
            const render = () => {
                let contentHtml = '';
                mainContent.className = "flex-grow overflow-y-auto relative";

                switch (state.activeScreen) {
                    case 'tap-clipz':
                        contentHtml = renderTapClipzScreen();
                        break;
                    case 'kuiz':
                        contentHtml = renderHeader() + renderKuizScreen();
                        break;
                    case 'calendar':
                        contentHtml = renderHeader() + renderCalendarScreen();
                        break;
                    case 'tanya-cloud':
                        mainContent.className = "flex-grow overflow-hidden relative";
                        contentHtml = renderTanyaCloudScreen();
                        break;
                    case 'settings':
                        contentHtml = renderHeader() + renderSettingsScreen();
                        break;
                }
                mainContent.innerHTML = contentHtml;
                renderBottomNav();
                renderModal();

                if (state.activeScreen === 'tanya-cloud' && !state.showChatHistory) {
                    const chatContainer = document.getElementById('chat-container');
                    if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            };

            // --- App Initialization ---
            const init = () => {
                loadData();
                applyTheme();
                addGlobalEventListeners(); // Listeners are now added only once

                // Inisialisasi video random pertama kali
                getRandomVideo();

                render();

                // Load prayer times if not available
                if (!state.prayerTimes.data) {
                    setTimeout(() => getPrayerTimes(), 2000);
                }
            };

            // Initialize app only after authentication
            window.initApp = init;
        });
    </script>
</body>

</html>
