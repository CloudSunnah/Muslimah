<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muslimah - by CLOUD SUNNAH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .splash-screen { background: linear-gradient(to bottom right, #fbcfe8, #fda4af); }
        .main-container { transition: background-color 0.5s ease; }
        .bottom-nav-button-active { transform: translateY(-0.5rem); }
        .chat-bubble-user { border-bottom-right-radius: 0; }
        .chat-bubble-bot { border-bottom-left-radius: 0; }
        .animate-pulse-dot { animation: pulse-dot 1.4s infinite ease-in-out both; }
        @keyframes pulse-dot {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .animate-pulse-dot:nth-child(1) { animation-delay: -0.32s; }
        .animate-pulse-dot:nth-child(2) { animation-delay: -0.16s; }
    </style>
</head>
<body class="overflow-hidden bg-rose-50 dark:bg-slate-900">

    <!-- Splash Screen -->
    <div id="splash-screen" class="splash-screen w-full h-screen flex flex-col justify-center items-center fixed inset-0 z-[100] transition-opacity duration-500">
        <div class="text-center">
            <h1 class="text-5xl font-bold text-white tracking-widest" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2)">MUSLIMAH</h1>
            <p class="text-white/80 mt-2 text-lg">by CLOUD SUNNAH</p>
        </div>
        <div class="absolute bottom-10 text-white/70 text-sm">Loading...</div>
    </div>

    <!-- Main App Container (will be managed by JS) -->
    <div id="app-container" class="font-sans antialiased w-full h-screen">
        <!-- Content (Login, Pending, Main App) is rendered here -->
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Konfigurasi Firebase Anda yang baru
        const firebaseConfig = {
            apiKey: "AIzaSyCyYsy5vPRlC8h6eu-o7J6hnSpFbYg-JnU",
            authDomain: "muslimah-ecc7f.firebaseapp.com",
            projectId: "muslimah-ecc7f",
            storageBucket: "muslimah-ecc7f.appspot.com",
            messagingSenderId: "429716762955",
            appId: "1:429716762955:web:e2cbc6728c4dab2c9a38ce",
            measurementId: "G-WDR3VGJKW0"
        };
        
        // Kunci API Gemini Anda
        const geminiApiKey = "AIzaSyCWXNHDk17P4q3Ed0GIIQazHlN_HNHc90w";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUserId = null;
        let unsubscribeUserStatus = () => {};

        // === App State and Logic ===
        document.addEventListener('DOMContentLoaded', () => {
            const appContainer = document.getElementById('app-container');
            const splashScreen = document.getElementById('splash-screen');

            const FIDYAH_PER_DAY = 45000;

            let state = {
                theme: 'light',
                activeScreen: 'calendar',
                currentDate: new Date(),
                isModalOpen: false,
                selectedDate: null,
                showChatHistory: false,
                tanyaCloud: {
                    prompt: '',
                    messages: [],
                    isLoading: false,
                    error: null,
                    chatHistory: [],
                },
                userData: {
                    menstruationDates: [],
                    fastingDebt: 0,
                }
            };

            const icons = {
                AlertTriangle: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>`,
                Mail: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>`,
                User: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
                Send: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>`,
                Clock: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
                CalendarDays: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></svg>`,
                Cloudy: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z" /><path d="M22 10a3 3 0 0 0-3-3h-2.207a5.502 5.502 0 0 0-10.702.5" /></svg>`,
                Settings: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0 2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></svg>`,
                Moon: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" /></svg>`,
                Sun: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>`,
                Minus: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M5 12h14" /></svg>`,
                Plus: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M5 12h14" /><path d="M12 5v14" /></svg>`,
                ChevronLeft: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="m15 18-6-6 6-6" /></svg>`,
                ChevronRight: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="m9 18 6-6-6-6" /></svg>`,
                SendHorizonal: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>`,
                History: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>`,
                Trash2: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`,
                ArrowLeft: (cn = "") => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cn}"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>`,
            };
            
            // --- AUTHENTICATION & UI FLOW MANAGEMENT ---

            const renderLoginScreen = () => {
                appContainer.innerHTML = `
                    <div class="flex flex-col justify-center items-center h-screen p-6 bg-rose-50 dark:bg-slate-900">
                        <div class="w-full max-w-sm text-center">
                            <h1 class="text-4xl font-bold text-pink-500 mb-2">Selamat Datang</h1>
                            <p class="text-slate-600 dark:text-slate-400 mb-8">Daftar untuk mendapatkan akses ke Aplikasi Muslimah.</p>
                            
                            <form id="registration-form" class="space-y-4">
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-400">
                                        ${icons.User("w-5 h-5")}
                                    </div>
                                    <input type="text" id="display-name" name="displayName" required placeholder="Nama Lengkap" class="w-full pl-10 pr-4 py-3 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400">
                                </div>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-slate-400">
                                        ${icons.Mail("w-5 h-5")}
                                    </div>
                                    <input type="email" id="email" name="email" required placeholder="Alamat Email" class="w-full pl-10 pr-4 py-3 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400">
                                </div>
                                <button type="submit" class="w-full flex items-center justify-center gap-2 bg-pink-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-600 transition-colors shadow-lg shadow-pink-500/30">
                                    ${icons.Send("w-5 h-5")}
                                    <span>Kirim Permintaan Akses</span>
                                </button>
                            </form>
                        </div>
                    </div>`;
                document.getElementById('registration-form').addEventListener('submit', handleRegistration);
            };

            const renderPendingScreen = (userData) => {
                appContainer.innerHTML = `
                    <div class="flex flex-col justify-center items-center h-screen p-6 text-center bg-rose-50 dark:bg-slate-900">
                        <div class="w-full max-w-md">
                            <div class="mx-auto mb-6 text-yellow-500">${icons.Clock("w-16 h-16")}</div>
                            <h1 class="text-2xl font-bold text-slate-800 dark:text-white">Terima Kasih, ${userData.displayName}!</h1>
                            <p class="text-slate-600 dark:text-slate-400 mt-4 mb-2">Permintaan akses Anda telah kami terima.</p>
                            <p class="text-slate-500 dark:text-slate-500">Admin akan segera meninjau permintaan Anda. Anda akan mendapatkan akses setelah disetujui. Silakan periksa kembali nanti.</p>
                        </div>
                    </div>`;
            };

            const initializeAppUI = () => {
                appContainer.innerHTML = `
                    <div class="font-sans antialiased w-full h-screen flex flex-col bg-rose-50 dark:bg-slate-900 main-container">
                        <main id="main-content" class="flex-grow overflow-y-auto"></main>
                        <nav id="bottom-nav-bar" class="shrink-0 bg-white/80 dark:bg-slate-800/80 backdrop-blur-lg border-t border-slate-200/80 dark:border-slate-700/80 rounded-t-3xl shadow-[0_-5px_20px_-5px_rgba(0,0,0,0.05)]"></nav>
                    </div>`;
                addGlobalEventListeners();
                loadDataFromFirestore();
            };

            const handleRegistration = async (e) => {
                e.preventDefault();
                const displayName = e.target.displayName.value.trim();
                const email = e.target.email.value.trim();
                if (!displayName || !email || !currentUserId) return;

                const userData = {
                    uid: currentUserId,
                    displayName,
                    email,
                    status: 'pending',
                    registeredAt: new Date().toISOString()
                };

                try {
                    const userDocRef = doc(db, "users", currentUserId);
                    await setDoc(userDocRef, userData);
                } catch (error) {
                    console.error("Error writing document: ", error);
                    alert("Gagal mengirim permintaan. Silakan coba lagi.");
                }
            };

            const checkUserStatus = (uid) => {
                const userDocRef = doc(db, "users", uid);
                unsubscribeUserStatus();
                unsubscribeUserStatus = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        if (userData.status === 'approved') {
                            if (!document.getElementById('main-content')) {
                                initializeAppUI();
                            }
                        } else {
                            renderPendingScreen(userData);
                        }
                    } else {
                        renderLoginScreen();
                    }
                });
            };

            const initAuth = () => {
                onAuthStateChanged(auth, user => {
                    setTimeout(() => {
                        splashScreen.style.opacity = '0';
                        setTimeout(() => splashScreen.style.display = 'none', 500);
                    }, 500);
                    
                    if (user) {
                        currentUserId = user.uid;
                        checkUserStatus(user.uid);
                    } else {
                        signInAnonymously(auth).catch((error) => {
                            console.error("Anonymous sign-in failed:", error);
                            
                            let errorTitle = "Kesalahan Konfigurasi Firebase";
                            let errorMessage = "";

                            if (error.code === 'auth/api-key-not-valid') {
                                errorMessage = `
                                    <p>Galat <strong>'${error.code}'</strong> berarti Kunci API Anda tidak valid. Mohon periksa kembali 3 hal ini di Firebase & Google Cloud Console:</p>
                                    <ol class="list-decimal list-inside mt-2 space-y-3 pl-2">
                                        <li>
                                            <strong>Kunci API Tepat?</strong><br>
                                            <span class="text-xs">Buka Pengaturan Proyek (⚙️) dan pastikan Kunci API (Web API Key) di sana sama persis dengan yang ada di file <code class="text-xs">index.html</code>.</span>
                                        </li>
                                        <li>
                                            <strong>Authentication Anonymous Aktif?</strong><br>
                                            <span class="text-xs">Buka <strong>Authentication &rarr; Sign-in method</strong>, dan pastikan provider <strong>Anonymous</strong> sudah diaktifkan (<strong>Enabled</strong>).</span>
                                        </li>
                                        <li>
                                            <strong>Tidak Ada Pembatasan Domain?</strong><br>
                                            <span class="text-xs">Di Google Cloud Console, periksa Kunci API Anda untuk memastikan tidak ada pembatasan domain (HTTP referrers) yang dapat memblokir akses. Untuk awal, sebaiknya tidak ada pembatasan.</span>
                                        </li>
                                    </ol>`;
                            } else if (error.message.includes('identity-toolkit-api-has-not-been-used')) {
                                errorTitle = "API Hampir Siap Digunakan";
                                errorMessage = `
                                    <p>Anda sudah mengaktifkan <strong>'Identity Toolkit API'</strong>, namun sistem Google terkadang butuh waktu untuk menerapkannya.</p>
                                    <ol class="list-decimal list-inside mt-2 space-y-3 pl-2">
                                        <li>
                                            <strong>Tunggu 5-10 Menit:</strong> Ini adalah penyebab paling umum. Silakan tutup halaman ini, tunggu beberapa menit, lalu coba buka kembali.
                                        </li>
                                        <li>
                                            <strong>Periksa Proyek yang Benar:</strong> Pastikan Anda mengaktifkan API pada proyek Google Cloud yang terhubung dengan Firebase ID <strong>'${firebaseConfig.projectId}'</strong>.
                                        </li>
                                        <li>
                                            <strong>Coba Muat Ulang Paksa (Hard Refresh):</strong> Tekan <code class="text-xs">Ctrl+Shift+R</code> (atau <code class="text-xs">Cmd+Shift+R</code> di Mac) untuk memastikan Anda tidak melihat versi <i>cache</i> dari aplikasi.
                                        </li>
                                    </ol>
                                    <p class="mt-4">Jika galat masih muncul setelah 15 menit, coba kunjungi kembali <a href="https://console.cloud.google.com/apis/library/identitytoolkit.googleapis.com" target="_blank" class="text-pink-500 underline"><strong>link aktivasi API</strong></a> untuk memastikan statusnya masih "Enabled".</p>
                                `;
                            } else {
                                errorMessage = `<p>Penyebab tidak diketahui. Silakan periksa konsol untuk detail lebih lanjut.</p>`;
                            }

                            appContainer.innerHTML = `
                                <div class="flex flex-col justify-center items-center h-screen p-6 text-center bg-red-50 dark:bg-slate-900">
                                    <div class="w-full max-w-lg p-8 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl">
                                        <div class="mx-auto mb-4 text-red-500">${icons.AlertTriangle("w-16 h-16")}</div>
                                        <h1 class="text-2xl font-bold text-slate-800 dark:text-white">${errorTitle}</h1>
                                        <p class="text-slate-600 dark:text-slate-400 mt-4 mb-2">Terjadi galat: <code class="bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-300 px-2 py-1 rounded-md text-sm">${error.code || 'UNKNOWN'}</code></p>
                                        <div class="text-slate-500 dark:text-slate-500 text-left mt-6 space-y-2">
                                            ${errorMessage}
                                        </div>
                                    </div>
                                </div>`;
                        });
                    }
                });
            };

            // --- DATA HANDLING (FIRESTORE) ---

            const saveDataToFirestore = async () => {
                if (!currentUserId) return;
                try {
                    const dataDocRef = doc(db, `users/${currentUserId}/appData`, 'main');
                    await setDoc(dataDocRef, { 
                        userData: state.userData,
                        theme: state.theme,
                        chatHistory: state.tanyaCloud.chatHistory
                    });
                } catch (e) { console.error("Failed to save data to Firestore:", e); }
            };

            const loadDataFromFirestore = async () => {
                if (!currentUserId) return;
                try {
                    const dataDocRef = doc(db, `users/${currentUserId}/appData`, 'main');
                    const docSnap = await getDoc(dataDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        state.userData = data.userData || state.userData;
                        state.theme = data.theme || state.theme;
                        state.tanyaCloud.chatHistory = data.chatHistory || [];
                    }
                } catch (e) { console.error("Failed to load data from Firestore:", e); }
                finally {
                    applyTheme();
                    render();
                }
            };

            // --- APPLICATION LOGIC & RENDERING ---
            const playClickSound = () => {
                 try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (e) {
                    console.log("Audio not supported");
                }
            };
            
            const toHijri = (gregorianDate) => {
                const int = (n) => Math.floor(n);
                const day = gregorianDate.getDate();
                const month = gregorianDate.getMonth();
                const year = gregorianDate.getFullYear();
                const jd = int((1461 * (year + 4800 + int((month - 14) / 12))) / 4) + int((367 * (month - 2 - 12 * (int((month - 14) / 12)))) / 12) - int((3 * (int((year + 4900 + int((month - 14) / 12)) / 100))) / 4) + day - 32075;
                const l = jd - 1948440 + 10632;
                const n = int((l - 1) / 10631);
                const i = l - 10631 * n + 354;
                const j = (int((10985 - i) / 5316)) * (int((50 * i) / 17719)) + (int(i / 5670)) * (int((43 * i) / 15238));
                const i2 = i - (int((30 - j) / 15)) * (int((17719 * j) / 50)) - (int(j / 16)) * (int((15238 * j) / 43)) + 29;
                const hMonth = int((24 * i2) / 709);
                const hDay = i2 - int((709 * hMonth) / 24);
                const hYear = 30 * n + j - 30;
                const monthNames = ["Muharram", "Safar", "Rabi' al-awwal", "Rabi' al-thani", "Jumada al-ula", "Jumada al-akhirah", "Rajab", "Sha'ban", "Ramadan", "Shawwal", "Dhu al-Qi'dah", "Dhu al-Hijjah"];
                return { day: hDay, month: hMonth, monthName: monthNames[hMonth - 1], year: hYear };
            };

            const applyTheme = () => {
                if (state.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            };

            const saveChatToHistory = (messages) => {
                if (messages.length === 0) return;
                const chatSession = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    messages: [...messages],
                    title: messages[0]?.text?.substring(0, 50) + (messages[0]?.text?.length > 50 ? '...' : '') || 'Chat Baru'
                };
                state.tanyaCloud.chatHistory.unshift(chatSession);
                if (state.tanyaCloud.chatHistory.length > 50) {
                    state.tanyaCloud.chatHistory = state.tanyaCloud.chatHistory.slice(0, 50);
                }
                saveDataToFirestore();
            };

            const loadChatFromHistory = (chatId) => {
                const chat = state.tanyaCloud.chatHistory.find(c => c.id === chatId);
                if (chat) {
                    state.tanyaCloud.messages = [...chat.messages];
                    state.showChatHistory = false;
                    render();
                }
            };

            const deleteChatFromHistory = (chatId) => {
                state.tanyaCloud.chatHistory = state.tanyaCloud.chatHistory.filter(c => c.id !== chatId);
                saveDataToFirestore();
                render();
            };

            const clearAllChatHistory = () => {
                state.tanyaCloud.chatHistory = [];
                saveDataToFirestore();
                render();
            };
            
            const renderHeader = () => `
                <header class="mb-6 flex justify-between items-center p-4 sm:p-6">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800 dark:text-white">Muslimah</h1>
                        <p class="text-slate-500 dark:text-slate-400">Your Daily Companion</p>
                    </div>
                </header>`;

            const renderCalendarScreen = () => {
                const { currentDate, userData } = state;
                const today = new Date();
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let calendarCells = '';
                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarCells += `<div class="bg-transparent"></div>`;
                }
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateObj = new Date(year, month, day);
                    const dateString = dateObj.toISOString().split('T')[0];
                    const hijri = toHijri(dateObj);
                    const isToday = dateObj.toDateString() === today.toDateString();
                    const isMenstruation = userData.menstruationDates.includes(dateString);
                    calendarCells += `
                        <div data-date="${dateString}" class="calendar-day relative h-14 flex flex-col justify-center items-center rounded-lg cursor-pointer transition-all duration-200 hover:bg-rose-100 dark:hover:bg-slate-700 ${isToday ? 'bg-pink-500 text-white' : 'text-slate-700 dark:text-slate-200'} ${isMenstruation ? 'bg-rose-200 dark:bg-rose-800/50' : ''}">
                            <span class="text-sm pointer-events-none">${day}</span>
                            <span class="text-xs pointer-events-none ${isToday ? 'text-white/70' : 'text-slate-400'}">${hijri.day}</span>
                            ${isMenstruation ? '<div class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full pointer-events-none"></div>' : ''}
                        </div>`;
                }
                return `
                    <div class="p-4 sm:p-6 space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-rose-100/50 dark:shadow-slate-950/50">
                                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Hutang Puasa</h3>
                                <p class="text-3xl font-bold text-pink-500 dark:text-pink-400">${userData.fastingDebt} <span class="text-lg">hari</span></p>
                            </div>
                            <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-rose-100/50 dark:shadow-slate-950/50">
                                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Total Fidyah</h3>
                                <p class="text-3xl font-bold text-pink-500 dark:text-pink-400">Rp ${(userData.fastingDebt * FIDYAH_PER_DAY).toLocaleString('id-ID')}</p>
                                <p class="text-xs text-slate-400 dark:text-slate-500">Asumsi Rp ${FIDYAH_PER_DAY.toLocaleString('id-ID')}/hari</p>
                            </div>
                        </div>
                        <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-rose-100/50 dark:shadow-slate-950/50">
                            <div class="flex justify-between items-center mb-4">
                                <button id="prev-month-btn" class="p-2 rounded-full hover:bg-rose-100 dark:hover:bg-slate-700">${icons.ChevronLeft("text-slate-600 dark:text-slate-300")}</button>
                                <div>
                                    <p class="font-bold text-lg text-slate-800 dark:text-white text-center">${currentDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' })}</p>
                                    <p class="text-sm text-slate-500 dark:text-slate-400 text-center">${toHijri(currentDate).monthName} ${toHijri(currentDate).year} H</p>
                                </div>
                                <button id="next-month-btn" class="p-2 rounded-full hover:bg-rose-100 dark:hover:bg-slate-700">${icons.ChevronRight("text-slate-600 dark:text-slate-300")}</button>
                            </div>
                            <div class="grid grid-cols-7 gap-1 text-center text-xs font-semibold text-slate-500 dark:text-slate-400 mb-2">
                                ${['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'].map(day => `<div>${day}</div>`).join('')}
                            </div>
                            <div id="calendar-grid" class="grid grid-cols-7 gap-1">${calendarCells}</div>
                        </div>
                        <div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-rose-100/50 dark:shadow-slate-950/50">
                            <h2 class="text-lg font-bold text-slate-800 dark:text-white mb-2">Manajemen Hutang Puasa</h2>
                            <div class="flex items-center justify-center gap-4 my-4">
                                <button id="decrease-debt-btn" class="p-3 bg-rose-100 dark:bg-slate-700 text-pink-600 dark:text-pink-400 rounded-full transition-transform active:scale-90">${icons.Minus("w-6 h-6")}</button>
                                <span class="text-5xl font-bold w-24 text-center text-slate-800 dark:text-white">${userData.fastingDebt}</span>
                                <button id="increase-debt-btn" class="p-3 bg-rose-100 dark:bg-slate-700 text-pink-600 dark:text-pink-400 rounded-full transition-transform active:scale-90">${icons.Plus("w-6 h-6")}</button>
                            </div>
                            <p class="text-center text-sm text-slate-500 dark:text-slate-400">Ubah jumlah hari hutang puasa Anda.</p>
                        </div>
                    </div>`;
            };
            
            const renderTanyaCloudScreen = () => { /* ... (This function will be added in the next step) ... */ return `<div class="p-6">Tanya Cloud Coming Soon!</div>` };
            const renderSettingsScreen = () => { /* ... (This function will be added in the next step) ... */ return `<div class="p-6">Settings Coming Soon!</div>` };

            const renderBottomNav = () => {
                const mainAppContainer = document.querySelector('.main-container');
                if (!mainAppContainer) return;
                
                const navBar = mainAppContainer.querySelector('#bottom-nav-bar');
                if (!navBar) return;

                const navItems = [
                    { id: 'calendar', label: 'Kalender', icon: icons.CalendarDays },
                    { id: 'tanya-cloud', label: 'Tanya Cloud', icon: icons.Cloudy },
                    { id: 'settings', label: 'Pengaturan', icon: icons.Settings },
                ];
                navBar.innerHTML = `
                    <div class="flex justify-around items-center max-w-md mx-auto h-20">
                        ${navItems.map(item => `
                            <button
                                data-screen="${item.id}"
                                class="nav-button flex flex-col items-center justify-center w-20 h-20 transition-all duration-300 transform ${state.activeScreen === item.id ? 'bottom-nav-button-active' : ''}"
                            >
                                <div class="p-3 rounded-full transition-all duration-300 pointer-events-none ${state.activeScreen === item.id ? 'bg-pink-500 shadow-lg shadow-pink-300/50 dark:shadow-pink-800/50' : ''}">
                                    ${item.icon(`transition-colors duration-300 pointer-events-none ${state.activeScreen === item.id ? 'text-white' : 'text-slate-500 dark:text-slate-400'}`)}
                                </div>
                                <span class="text-xs mt-1 font-bold transition-colors duration-300 pointer-events-none ${state.activeScreen === item.id ? 'text-pink-600 dark:text-pink-400' : 'text-slate-500 dark:text-slate-400'}">
                                    ${item.label}
                                </span>
                            </button>
                        `).join('')}
                    </div>
                `;
            };

            const renderModal = () => {
                 if (state.isModalOpen && state.selectedDate) {
                    const date = new Date(state.selectedDate);
                    const isMarked = state.userData.menstruationDates.includes(state.selectedDate);
                    const modalHtml = `
                    <div id="menstruation-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex justify-center items-center z-50 p-4">
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-full max-w-sm text-center shadow-2xl">
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-2">
                               ${date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                            </h2>
                            <p class="text-slate-500 dark:text-slate-400 mb-6">Tandai sebagai tanggal menstruasi?</p>
                            <div class="flex flex-col gap-3">
                                <button id="toggle-menstruation-btn" class="w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-600 transition-colors">
                                    ${isMarked ? 'Hapus Tanda' : 'Tandai Menstruasi'}
                                </button>
                                <button id="cancel-modal-btn" class="w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-bold py-3 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                                    Batal
                                </button>
                            </div>
                        </div>
                    </div>`;
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                } else {
                    const modal = document.getElementById('menstruation-modal');
                    if (modal) modal.remove();
                }
            };
            
            const addGlobalEventListeners = () => {
                appContainer.addEventListener('click', (e) => {
                    const navButton = e.target.closest('.nav-button');
                    if(navButton) setActiveScreen(navButton.dataset.screen);
                    
                    if (e.target.closest('#prev-month-btn')) changeMonth(-1);
                    if (e.target.closest('#next-month-btn')) changeMonth(1);
                    const dayElement = e.target.closest('.calendar-day');
                    if(dayElement) handleDayClick(dayElement.dataset.date);

                    if (e.target.closest('#decrease-debt-btn')) handleDebtChange(-1);
                    if (e.target.closest('#increase-debt-btn')) handleDebtChange(1);
                });

                document.body.addEventListener('click', e => {
                    if (e.target.closest('#toggle-menstruation-btn')) handleToggleMenstruation();
                    if (e.target.closest('#cancel-modal-btn')) closeModal();
                });
            };

            const setActiveScreen = (screen) => { playClickSound(); state.activeScreen = screen; render(); };
            const changeMonth = (offset) => { playClickSound(); state.currentDate.setMonth(state.currentDate.getMonth() + offset, 1); render(); };
            const handleDayClick = (dateString) => { playClickSound(); state.selectedDate = dateString; state.isModalOpen = true; render(); };
            const closeModal = () => { playClickSound(); state.isModalOpen = false; render(); };
            const handleToggleMenstruation = () => {
                playClickSound();
                if (!state.selectedDate) return;
                const index = state.userData.menstruationDates.indexOf(state.selectedDate);
                if (index > -1) {
                    state.userData.menstruationDates.splice(index, 1);
                } else {
                    state.userData.menstruationDates.push(state.selectedDate);
                }
                saveDataToFirestore();
                closeModal();
            };
            const handleDebtChange = (amount) => {
                playClickSound();
                state.userData.fastingDebt = Math.max(0, state.userData.fastingDebt + amount);
                saveDataToFirestore();
                render();
            };
            
            const render = () => {
                const mainContent = document.getElementById('main-content');
                if (!mainContent) return;
                let contentHtml = '';
                switch (state.activeScreen) {
                    case 'calendar':
                        contentHtml = renderHeader() + renderCalendarScreen();
                        break;
                    case 'tanya-cloud':
                        contentHtml = renderHeader() + renderTanyaCloudScreen();
                        break;
                    case 'settings':
                        contentHtml = renderHeader() + renderSettingsScreen();
                        break;
                }
                mainContent.innerHTML = contentHtml;
                renderBottomNav();
                renderModal();
            };
            
            // --- App Initialization ---
            const init = () => {
                initAuth();
            };

            init();
        });
    </script>
</body>
</html>

